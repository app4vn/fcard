<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Flashcard Tiếng Anh (Nâng cấp)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            transform-style: preserve-3d;
            transition: transform 0.7s;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .flashcard.practice-mode-front-only {
            transform: rotateY(0deg) !important;
            cursor: default;
        }
        .card-scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .card-scrollable-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .card-scrollable-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .card-scrollable-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .highlighted-word {
            background-color: #fef08a;
            color: #1f2937 !important;
            padding: 1px 3px;
            border-radius: 3px;
            box-shadow: 0 0 5px rgba(254, 240, 138, 0.5);
        }
        #filter-sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #speaker-btn, #speaker-example-btn {
            z-index: 10;
        }
        #typing-input::placeholder {
            color: #9ca3af;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          }
        }
      }
    </script>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col min-h-screen">

    <header class="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <button id="hamburger-menu-btn" title="Mở bộ lọc" class="text-2xl p-2 hover:bg-slate-700 rounded-md">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="text-xl sm:text-2xl font-semibold text-center flex-grow">Flashcard Học Từ Vựng</h1>
            <div class="w-10 h-10"></div>
        </div>
    </header>

    <aside id="filter-sidebar" class="fixed top-0 left-0 w-72 h-full bg-white shadow-xl p-5 transform -translate-x-full z-[1001] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-slate-700">Bộ lọc & Thêm thẻ</h2>
            <button id="close-sidebar-btn" title="Đóng bộ lọc" class="text-2xl text-slate-500 hover:text-slate-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <section class="controls space-y-5">
            <div>
                <button id="open-add-card-modal-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out mb-4">
                    <i class="fas fa-plus mr-2"></i>Thêm thẻ mới
                </button>
            </div>
            <div class="control-group category-selection">
                <label for="category" class="block text-sm font-medium text-slate-600 mb-1">Chọn loại từ:</label>
                <select id="category" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="verbs">Động từ</option>
                    <option value="adjectives">Tính từ</option>
                    <option value="nouns">Danh từ</option>
                    <option value="phrasalVerbs">Cụm động từ</option>
                </select>
            </div>

            <div id="base-verb-filter-container" class="control-group base-verb-filter" style="display:none;">
                <label for="base-verb-filter" class="block text-sm font-medium text-slate-600 mb-1">Lọc theo từ gốc:</label>
                <select id="base-verb-filter" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>

            <div id="tag-filter-container" class="control-group tag-filter" style="display:none;">
                <label for="tags" class="block text-sm font-medium text-slate-600 mb-1">Lọc theo chủ đề:</label>
                <select id="tags" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>

            <div class="control-group practice-mode-selection">
                <label for="practice-type-select" class="block text-sm font-medium text-slate-600 mb-1">Chế độ Luyện tập:</label>
                <select id="practice-type-select" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="off">Tắt luyện tập</option>
                    <option value="meaning_quiz">Luyện tập: Chọn Nghĩa</option>
                    <option value="word_quiz">Luyện tập: Chọn Từ</option>
                    <option value="typing_practice">Luyện tập: Gõ Từ/Cụm từ</option>
                </select>
            </div>

            <div class="control-group card-status-filter">
                <label for="filter-card-status" class="block text-sm font-medium text-slate-600 mb-1">Hiển thị thẻ:</label>
                <select id="filter-card-status" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="all_study">Từ mới & Đang học</option>
                    <option value="all_visible">Tất cả (gồm Đã thuộc)</option>
                    <option value="new">Chỉ Từ mới</option>
                    <option value="learning">Chỉ Đang học</option>
                    <option value="learned">Chỉ Đã thuộc</option>
                </select>
            </div>
        </section>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden"></div>

    <main class="container mx-auto p-4 sm:p-6 flex-grow w-full max-w-2xl flex flex-col items-center">
        <section class="search-filter-main-container w-full mb-4">
            <div class="control-group bg-white p-3 rounded-lg shadow">
                <label for="search-input" class="sr-only">Tìm kiếm:</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input type="search" id="search-input" placeholder="Nhập từ tiếng Anh..." class="w-full p-3 pl-10 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </section>

        <section id="practice-area" class="practice-mode-controls w-full mb-4" style="display:none;">
            <div id="typing-input-container" class="w-full mb-2" style="display:none;">
                 <input type="text" id="typing-input" placeholder="Gõ câu trả lời của bạn..." class="w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-slate-700 bg-white">
                 <button id="submit-typing-answer-btn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out">Kiểm tra</button>
            </div>
            <div id="multiple-choice-options" class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full"></div>
            <div id="feedback-message" class="mt-3 p-3 rounded-md w-full text-center font-semibold hidden"></div>
        </section>

        <section class="flashcard-container w-full h-[380px] sm:h-[400px] mb-4">
            <div id="flashcard" class="flashcard relative w-full h-full">
                <div class="card-front absolute w-full h-full bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl shadow-xl p-5 flex flex-col items-center justify-center overflow-hidden">
                    <div class="card-scrollable-content w-full h-full overflow-y-auto flex flex-col items-center justify-center text-center p-2 pb-16">
                        <div id="word-display" class="text-3xl sm:text-4xl font-bold break-words"></div>
                        <p id="pronunciation-display" class="pronunciation text-lg sm:text-xl text-green-100 mt-2 bg-black bg-opacity-20 px-3 py-1 rounded-md"></p>
                        <div id="tags-display-front" class="tags-front text-sm text-green-200 mt-3 italic"></div>
                    </div>
                    <button id="speaker-btn" title="Phát âm Từ/Cụm từ" class="absolute bottom-4 left-4 text-2xl sm:text-3xl text-white hover:text-green-200 transition-colors p-2 rounded-full hover:bg-black hover:bg-opacity-20">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                <div class="card-back absolute w-full h-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl shadow-xl p-5 flex flex-col items-center overflow-hidden">
                    <div class="card-scrollable-content w-full h-full overflow-y-auto text-left p-2 pb-16 space-y-3">
                        <div class="meaning-section bg-black bg-opacity-20 p-3 rounded-lg">
                            <p id="meaning-display" class="text-xl sm:text-2xl font-semibold"></p>
                        </div>
                        <div class="example-section border-t border-blue-400 pt-3">
                            <p class="text-sm font-medium text-indigo-200 mb-1">Ví dụ (Tiếng Anh):</p>
                            <p id="example-display" class="example text-base sm:text-lg bg-black bg-opacity-10 p-2 rounded-md"></p>
                        </div>
                        <div class="example-vie-section border-t border-blue-400 pt-3">
                             <p class="text-sm font-medium text-indigo-200 mb-1">Nghĩa ví dụ (Tiếng Việt):</p>
                            <p id="example-vie-display" class="example-vie text-base sm:text-lg italic text-indigo-100"></p>
                        </div>
                        <div class="notes-section border-t border-blue-400 pt-3">
                            <p id="notes-display" class="notes text-sm text-indigo-200"></p>
                        </div>
                    </div>
                     <button id="speaker-example-btn" title="Phát âm Ví dụ" class="absolute bottom-4 right-4 text-2xl sm:text-3xl text-white hover:text-indigo-200 transition-colors p-2 rounded-full hover:bg-black hover:bg-opacity-20">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            </div>
        </section>

        <section class="status-controls grid grid-cols-3 gap-2 sm:gap-3 w-full max-w-md mb-2">
            <button id="btn-status-new" class="py-2 px-3 sm:py-3 sm:px-4 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-md shadow-sm border border-slate-300 transition duration-150 ease-in-out">Từ mới</button>
            <button id="btn-status-learning" class="py-2 px-3 sm:py-3 sm:px-4 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-md shadow-sm border border-slate-300 transition duration-150 ease-in-out">Đang học</button>
            <button id="btn-status-learned" class="py-2 px-3 sm:py-3 sm:px-4 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-md shadow-sm border border-slate-300 transition duration-150 ease-in-out">Đã thuộc</button>
        </section>
        
        <section id="user-card-actions" class="flex justify-center gap-2 sm:gap-3 w-full max-w-md mb-4" style="display: none;">
            <button id="edit-card-btn" class="py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-md shadow-sm transition duration-150 ease-in-out">
                <i class="fas fa-edit mr-1"></i> Sửa thẻ này
            </button>
            <button id="delete-card-btn" class="py-2 px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-md shadow-sm transition duration-150 ease-in-out">
                <i class="fas fa-trash-alt mr-1"></i> Xóa thẻ này
            </button>
        </section>


        <section class="navigation flex justify-between items-center w-full max-w-md mb-4">
            <button id="prev-btn" class="py-3 px-6 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-arrow-left mr-1"></i> Trước
            </button>
            <button id="flip-btn" class="py-3 px-6 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-sync-alt mr-1"></i> Lật thẻ
            </button>
            <button id="next-btn" class="py-3 px-6 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Tiếp <i class="fas fa-arrow-right ml-1"></i>
            </button>
        </section>

        <section class="card-info text-center text-slate-600 text-sm mb-6">
            <p>Thẻ <span id="current-card-index" class="font-semibold">0</span> / <span id="total-cards" class="font-semibold">0</span></p>
        </section>
    </main>

    <footer class="bg-slate-800 text-white p-4 text-center mt-auto">
        <p>&copy; 2025 Flashcard App</p>
    </footer>

    <div id="add-edit-card-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[1002] hidden opacity-0">
        <div class="modal-content bg-white p-6 sm:p-8 rounded-lg shadow-xl w-11/12 max-w-lg mx-auto transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-semibold text-slate-700">Thêm thẻ mới</h2>
                <button id="close-modal-btn" class="text-2xl text-slate-500 hover:text-slate-700">&times;</button>
            </div>
            <form id="add-edit-card-form" class="space-y-4">
                <input type="hidden" id="card-id-input"> <div>
                    <label for="card-word-input" class="block text-sm font-medium text-slate-600">Từ/Cụm từ (Tiếng Anh) <span class="text-red-500">*</span></label>
                    <input type="text" id="card-word-input" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="card-pronunciation-input" class="block text-sm font-medium text-slate-600">Phát âm</label>
                    <input type="text" id="card-pronunciation-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="card-meaning-input" class="block text-sm font-medium text-slate-600">Nghĩa (Tiếng Việt) <span class="text-red-500">*</span></label>
                    <input type="text" id="card-meaning-input" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="card-example-input" class="block text-sm font-medium text-slate-600">Câu ví dụ (Tiếng Anh)</label>
                    <textarea id="card-example-input" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label for="card-example-vie-input" class="block text-sm font-medium text-slate-600">Nghĩa câu ví dụ (Tiếng Việt)</label>
                    <textarea id="card-example-vie-input" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                 <div>
                    <label for="card-notes-input" class="block text-sm font-medium text-slate-600">Ghi chú</label>
                    <textarea id="card-notes-input" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div id="phrasal-verb-specific-fields" style="display: none;">
                    <div>
                        <label for="card-base-verb-input" class="block text-sm font-medium text-slate-600">Động từ gốc (Base Verb)</label>
                        <input type="text" id="card-base-verb-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: get, put, take...">
                    </div>
                    <div>
                        <label for="card-tags-input" class="block text-sm font-medium text-slate-600">Chủ đề (Tags - cách nhau bởi dấu phẩy)</label>
                        <input type="text" id="card-tags-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: actions_general, communication...">
                        <p class="mt-1 text-xs text-slate-500">Xem danh sách tags gợi ý trong Bộ lọc.</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-card-btn" class="py-2 px-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-md shadow-sm">Hủy</button>
                    <button type="submit" id="save-card-btn" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md shadow-md">Lưu thẻ</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const tagDisplayNames = {
            "all": "Tất cả chủ đề", // All themes
            "actions_general": "Hành động chung", "actions_tasks": "Hành động & Nhiệm vụ", // General actions, Actions & Tasks
            "movement_travel": "Di chuyển & Du lịch", "communication": "Giao tiếp", // Movement & Travel, Communication
            "relationships_social": "Quan hệ & Xã hội", "emotions_feelings": "Cảm xúc & Cảm giác", // Relationships & Social, Emotions & Feelings
            "problems_solutions": "Vấn đề & Giải pháp", "work_business": "Công việc & Kinh doanh", // Problems & Solutions, Work & Business
            "learning_information": "Học tập & Thông tin", "daily_routine": "Thói quen hàng ngày", // Learning & Information, Daily Routine
            "health_wellbeing": "Sức khỏe & Tinh thần", "objects_possession": "Đồ vật & Sở hữu", // Health & Wellbeing, Objects & Possession
            "time_planning": "Thời gian & Kế hoạch", "money_finance": "Tiền bạc & Tài chính", // Time & Planning, Money & Finance
            "behavior_attitude": "Hành vi & Thái độ", "begin_end_change": "Bắt đầu, Kết thúc & Thay đổi", // Behavior & Attitude, Begin, End & Change
            "food_drink": "Ăn uống", "home_living": "Nhà cửa & Đời sống", // Food & Drink, Home & Living
            "rules_systems": "Quy tắc & Hệ thống", "effort_achievement": "Nỗ lực & Thành tựu", // Rules & Systems, Effort & Achievement
            "safety_danger": "An toàn & Nguy hiểm", "technology": "Công nghệ", // Safety & Danger, Technology
            "nature": "Thiên nhiên & Thời tiết", "art_creation": "Nghệ thuật & Sáng tạo" // Nature & Weather, Art & Creation
        };

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const categorySelect = document.getElementById('category');
            const flashcard = document.getElementById('flashcard');
            const wordDisplay = document.getElementById('word-display');
            const pronunciationDisplay = document.getElementById('pronunciation-display');
            const meaningDisplay = document.getElementById('meaning-display');
            const exampleDisplay = document.getElementById('example-display');
            const exampleVieDisplay = document.getElementById('example-vie-display');
            const notesDisplay = document.getElementById('notes-display');
            const prevBtn = document.getElementById('prev-btn');
            const flipBtn = document.getElementById('flip-btn');
            const nextBtn = document.getElementById('next-btn');
            const currentCardIndexDisplay = document.getElementById('current-card-index');
            const totalCardsDisplay = document.getElementById('total-cards');
            const speakerBtn = document.getElementById('speaker-btn');
            const speakerExampleBtn = document.getElementById('speaker-example-btn');
            const tagFilterContainer = document.getElementById('tag-filter-container');
            const tagSelect = document.getElementById('tags');
            const searchInput = document.getElementById('search-input');
            const baseVerbFilterContainer = document.getElementById('base-verb-filter-container');
            const baseVerbSelect = document.getElementById('base-verb-filter');
            const practiceTypeSelect = document.getElementById('practice-type-select');
            const practiceArea = document.getElementById('practice-area');
            const multipleChoiceOptionsContainer = document.getElementById('multiple-choice-options');
            const feedbackMessage = document.getElementById('feedback-message');
            const filterCardStatusSelect = document.getElementById('filter-card-status');
            const statusBtnNew = document.getElementById('btn-status-new');
            const statusBtnLearning = document.getElementById('btn-status-learning');
            const statusBtnLearned = document.getElementById('btn-status-learned');
            const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
            const filterSidebar = document.getElementById('filter-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const tagsDisplayFront = document.getElementById('tags-display-front');
            const typingInputContainer = document.getElementById('typing-input-container');
            const typingInput = document.getElementById('typing-input');
            const submitTypingAnswerBtn = document.getElementById('submit-typing-answer-btn');
            
            // New DOM Elements for Add/Edit/Delete
            const openAddCardModalBtn = document.getElementById('open-add-card-modal-btn');
            const addEditCardModal = document.getElementById('add-edit-card-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addEditCardForm = document.getElementById('add-edit-card-form');
            const modalTitle = document.getElementById('modal-title');
            const cardIdInput = document.getElementById('card-id-input'); // Hidden input for card's unique ID during edit
            const cardWordInput = document.getElementById('card-word-input');
            const cardPronunciationInput = document.getElementById('card-pronunciation-input');
            const cardMeaningInput = document.getElementById('card-meaning-input');
            const cardExampleInput = document.getElementById('card-example-input');
            const cardExampleVieInput = document.getElementById('card-example-vie-input');
            const cardNotesInput = document.getElementById('card-notes-input');
            const phrasalVerbSpecificFields = document.getElementById('phrasal-verb-specific-fields');
            const cardBaseVerbInput = document.getElementById('card-base-verb-input');
            const cardTagsInput = document.getElementById('card-tags-input');
            const cancelCardBtn = document.getElementById('cancel-card-btn');
            const saveCardBtn = document.getElementById('save-card-btn');
            const userCardActions = document.getElementById('user-card-actions');
            const editCardBtn = document.getElementById('edit-card-btn');
            const deleteCardBtn = document.getElementById('delete-card-btn');


            // State Variables
            let currentData = [];
            let currentIndex = 0;
            let currentWordSpansMeta = [];
            let activeMasterList = []; 
            
            let practiceType = "off";
            let currentAnswerChecked = false;
            let currentCorrectAnswerForPractice = '';
            
            let cardStatuses = {};
            const cardStatusesStorageKey = 'flashcardCardStatuses_v2_crud'; 
            
            let appState = {
                lastSelectedCategory: 'phrasalVerbs',
                categoryStates: {}
            };
            const appStateStorageKey = 'flashcardAppState_v2_crud';
            const userCardsStorageKey = 'userFlashcards_v2'; // For user-created cards

            let learningCardNextButtonTimer = null;
            let learningCardCountdownInterval = null;

            let exampleSpeechQueue = [];
            let currentExampleSpeechIndex = 0;
            let isSpeakingExampleQueue = false;
            let currentEditingCardId = null; // To store the ID of the card being edited

            // --- Initialization ---
            loadAppState();
            loadCardStatuses();
            setupInitialCategory(); // This will also call loadVocabularyData
            setupEventListeners();


            // --- UI Functions (Sidebar, Modal, etc.) ---
            function openSidebar() {
                filterSidebar.classList.remove('-translate-x-full');
                filterSidebar.classList.add('translate-x-0');
                sidebarOverlay.classList.remove('hidden');
                updateSidebarFilterVisibility();
            }

            function closeSidebar() {
                filterSidebar.classList.add('-translate-x-full');
                filterSidebar.classList.remove('translate-x-0');
                sidebarOverlay.classList.add('hidden');
            }

            function updateSidebarFilterVisibility() {
                const category = categorySelect.value;
                if (category === 'phrasalVerbs') {
                    baseVerbFilterContainer.style.display = 'block';
                    tagFilterContainer.style.display = 'block';
                } else {
                    baseVerbFilterContainer.style.display = 'none';
                    tagFilterContainer.style.display = 'none';
                }
            }

            function openAddEditModal(mode = 'add', cardData = null) {
                modalTitle.textContent = mode === 'add' ? 'Thêm thẻ mới' : 'Sửa thẻ';
                addEditCardForm.reset(); // Clear previous form data
                cardIdInput.value = ''; // Clear hidden ID input
                currentEditingCardId = null;

                phrasalVerbSpecificFields.style.display = categorySelect.value === 'phrasalVerbs' ? 'block' : 'none';

                if (mode === 'edit' && cardData) {
                    currentEditingCardId = cardData.id; // Store the unique ID of the user card
                    cardIdInput.value = cardData.id; // Set hidden input for form submission if needed (though currentEditingCardId is primary)
                    
                    // Populate form with existing card data
                    if (categorySelect.value === 'phrasalVerbs') {
                        cardWordInput.value = cardData.phrasalVerb || '';
                        cardBaseVerbInput.value = cardData.baseVerb || '';
                        cardTagsInput.value = Array.isArray(cardData.tags) ? cardData.tags.filter(t => t !== 'all' && !t.startsWith('particle_')).join(', ') : '';
                    } else {
                        cardWordInput.value = cardData.word || '';
                    }
                    cardPronunciationInput.value = cardData.pronunciation || '';
                    cardMeaningInput.value = cardData.meaning || '';
                    cardExampleInput.value = (cardData.example || '').replace(/^Ví dụ:\s*/i, '').trim();
                    cardExampleVieInput.value = cardData.exampleVie || '';
                    cardNotesInput.value = cardData.notes || '';
                }
                
                addEditCardModal.classList.remove('hidden', 'opacity-0');
                addEditCardModal.querySelector('.modal-content').classList.remove('scale-95');
                addEditCardModal.querySelector('.modal-content').classList.add('scale-100');
            }

            function closeAddEditModal() {
                addEditCardModal.classList.add('opacity-0');
                addEditCardModal.querySelector('.modal-content').classList.add('scale-95');
                addEditCardModal.querySelector('.modal-content').classList.remove('scale-100');
                setTimeout(() => {
                    addEditCardModal.classList.add('hidden');
                }, 250); // Match transition duration
            }
            
            // --- Timer for "Learning" Status Cards ---
            function clearLearningTimer() {
                clearTimeout(learningCardNextButtonTimer);
                learningCardNextButtonTimer = null;
                clearInterval(learningCardCountdownInterval);
                learningCardCountdownInterval = null;
                if (nextBtn && nextBtn.textContent.includes('(')) {
                    nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                }
            }

            function startLearningTimer() {
                clearLearningTimer();

                if (currentData.length === 0 || practiceType !== "off" || !nextBtn) {
                    if (nextBtn) {
                        nextBtn.disabled = (currentIndex >= currentData.length - 1 || currentData.length === 0);
                         if (!nextBtn.textContent.includes('(')) {
                             nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                         }
                    }
                    updateCardInfo();
                    return;
                }

                const item = currentData[currentIndex];
                const categoryValue = categorySelect.value;
                const cardIdentifier = getCardIdentifier(item, categoryValue); // This uses word/phrasal verb
                const currentCardStatus = getCardStatus(cardIdentifier, categoryValue);

                if (currentCardStatus === 'learning' && !item.isUserCard) { // Timer only for non-user cards in learning
                    nextBtn.disabled = true;
                    let countdown = 30;
                    nextBtn.innerHTML = `Tiếp (${countdown}s) <i class="fas fa-arrow-right ml-1"></i>`;

                    learningCardCountdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            if (nextBtn.disabled) nextBtn.innerHTML = `Tiếp (${countdown}s) <i class="fas fa-arrow-right ml-1"></i>`;
                        } else {
                            clearInterval(learningCardCountdownInterval);
                            learningCardCountdownInterval = null;
                        }
                    }, 1000);

                    learningCardNextButtonTimer = setTimeout(() => {
                        clearInterval(learningCardCountdownInterval);
                        learningCardCountdownInterval = null;
                        nextBtn.disabled = false;
                        nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                        updateCardInfo();
                    }, 30000);
                } else {
                    nextBtn.disabled = (currentIndex >= currentData.length - 1 || currentData.length === 0);
                    nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                }
                updateCardInfo();
            }

            // --- State Management (App State & Card Statuses & User Cards) ---
            function loadAppState() {
                try {
                    const storedState = localStorage.getItem(appStateStorageKey);
                    if (storedState) {
                        const parsedState = JSON.parse(storedState);
                        appState.lastSelectedCategory = parsedState.lastSelectedCategory || 'phrasalVerbs';
                        appState.categoryStates = parsedState.categoryStates || {};
                        Object.keys(appState.categoryStates).forEach(catKey => {
                            if (appState.categoryStates[catKey]) {
                                appState.categoryStates[catKey].searchTerm = ''; 
                            }
                        });
                    } else {
                         appState.lastSelectedCategory = 'phrasalVerbs';
                         appState.categoryStates = {};
                    }
                } catch (e) {
                    console.warn("Không thể tải trạng thái ứng dụng từ localStorage:", e);
                    appState.lastSelectedCategory = 'phrasalVerbs';
                    appState.categoryStates = {};
                }
            }

            function saveAppState() {
                try {
                    const currentCategoryValue = categorySelect.value;
                    const stateForCategory = getCategoryState(currentCategoryValue); 
                    stateForCategory.currentIndex = currentIndex;
                    stateForCategory.filterMarked = filterCardStatusSelect.value; 
                    if (currentCategoryValue === 'phrasalVerbs') {
                        stateForCategory.baseVerb = baseVerbSelect.value;
                        stateForCategory.tag = tagSelect.value;
                    }
                    appState.lastSelectedCategory = currentCategoryValue; 
                    localStorage.setItem(appStateStorageKey, JSON.stringify(appState));
                } catch (e) {
                    console.warn("Không thể lưu trạng thái ứng dụng vào localStorage:", e);
                }
            }

            function getCategoryState(categoryValue) {
                if (!appState.categoryStates[categoryValue]) {
                    appState.categoryStates[categoryValue] = {
                        searchTerm: '', baseVerb: 'all', tag: 'all', filterMarked: 'all_study', currentIndex: 0
                    };
                } else {
                    if (appState.categoryStates[categoryValue].searchTerm === undefined) {
                         appState.categoryStates[categoryValue].searchTerm = '';
                    }
                }
                return appState.categoryStates[categoryValue];
            }
            
            function loadCardStatuses() {
                try {
                    const storedStatuses = localStorage.getItem(cardStatusesStorageKey);
                    cardStatuses = storedStatuses ? JSON.parse(storedStatuses) : {};
                } catch (e) {
                    console.error("Không thể tải trạng thái thẻ từ localStorage:", e);
                    cardStatuses = {};
                }
            }

            function saveCardStatuses() {
                try {
                    localStorage.setItem(cardStatusesStorageKey, JSON.stringify(cardStatuses));
                } catch (e) {
                    console.error("Không thể lưu trạng thái thẻ vào localStorage:", e);
                }
            }

            function getCardIdentifier(item, categoryValue) {
                if (!item) return null;
                // For user-created cards, if they have a unique 'id', that could be used.
                // But for consistency with existing static cards and status logic, we use word/phrasalVerb.
                return (categoryValue === 'phrasalVerbs') ? item.phrasalVerb : item.word;
            }

            function getCardStatus(cardIdentifier, categoryValue) {
                if (!cardIdentifier || !categoryValue || !cardStatuses[categoryValue] || !cardStatuses[categoryValue][cardIdentifier]) {
                    return 'new'; 
                }
                return cardStatuses[categoryValue][cardIdentifier];
            }

            function setCardStatus(newStatus) {
                if (currentData.length === 0) return;
                const item = currentData[currentIndex];
                const categoryValue = categorySelect.value;
                const cardIdentifier = getCardIdentifier(item, categoryValue);

                if (!cardIdentifier) return;

                if (!cardStatuses[categoryValue]) {
                    cardStatuses[categoryValue] = {};
                }
                cardStatuses[categoryValue][cardIdentifier] = newStatus;
                saveCardStatuses();
                updateStatusButtonsUI(cardIdentifier, categoryValue); 
                startLearningTimer(); 

                if (newStatus === 'learned' && getCategoryState(categoryValue).filterMarked === 'all_study') {
                     applyAllFilters(); 
                }
            }
            
            function updateStatusButtonsUI(cardIdentifier, categoryValue) {
                const statusButtons = [
                    { btn: statusBtnNew, status: 'new' }, { btn: statusBtnLearning, status: 'learning' }, { btn: statusBtnLearned, status: 'learned' }
                ];
                const item = currentData.length > 0 ? currentData[currentIndex] : null;

                if (!item || !cardIdentifier) {
                    statusButtons.forEach(obj => {
                        if(obj.btn) { 
                            obj.btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-700');
                            obj.btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
                            obj.btn.disabled = true;
                        }
                    });
                    userCardActions.style.display = 'none'; // Hide edit/delete if no card
                    return;
                }

                statusButtons.forEach(obj => { if(obj.btn) obj.btn.disabled = false; });
                const currentStatus = getCardStatus(cardIdentifier, categoryValue);
                statusButtons.forEach(obj => {
                    if (obj.btn) {
                        obj.btn.classList.toggle('bg-indigo-600', obj.status === currentStatus);
                        obj.btn.classList.toggle('text-white', obj.status === currentStatus);
                        obj.btn.classList.toggle('border-indigo-700', obj.status === currentStatus);
                        obj.btn.classList.toggle('bg-white', obj.status !== currentStatus);
                        obj.btn.classList.toggle('text-slate-700', obj.status !== currentStatus);
                        obj.btn.classList.toggle('border-slate-300', obj.status !== currentStatus);
                    }
                });

                if (statusBtnNew) statusBtnNew.disabled = (currentStatus === 'learning' && !item.isUserCard); // Original logic for learning timer

                // Show Edit/Delete buttons only for user-created cards
                if (item.isUserCard) {
                    userCardActions.style.display = 'flex';
                } else {
                    userCardActions.style.display = 'none';
                }
            }

            // --- User Card Management (CRUD) ---
            function loadUserCards() {
                try {
                    const storedUserCards = localStorage.getItem(userCardsStorageKey);
                    return storedUserCards ? JSON.parse(storedUserCards) : {};
                } catch (e) {
                    console.error("Lỗi tải thẻ người dùng từ localStorage:", e);
                    return {};
                }
            }

            function saveUserCards(allUserCards) {
                try {
                    localStorage.setItem(userCardsStorageKey, JSON.stringify(allUserCards));
                } catch (e) {
                    console.error("Lỗi lưu thẻ người dùng vào localStorage:", e);
                }
            }

            function handleSaveCard() {
                const category = categorySelect.value;
                const word = cardWordInput.value.trim();
                const meaning = cardMeaningInput.value.trim();

                if (!word || !meaning) {
                    alert("Từ/Cụm từ và Nghĩa là bắt buộc!");
                    return;
                }

                const newCard = {
                    id: currentEditingCardId || `user_${category}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // Generate new ID if not editing
                    pronunciation: cardPronunciationInput.value.trim(),
                    meaning: meaning,
                    example: cardExampleInput.value.trim(),
                    exampleVie: cardExampleVieInput.value.trim(),
                    notes: cardNotesInput.value.trim(),
                    isUserCard: true // Mark as user-created
                };

                if (category === 'phrasalVerbs') {
                    newCard.phrasalVerb = word;
                    newCard.baseVerb = cardBaseVerbInput.value.trim() || null; // Allow empty base verb
                    newCard.tags = cardTagsInput.value.trim() ? cardTagsInput.value.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : [];
                     // Automatically add base verb as a particle tag if not already present in a complex way
                    if (newCard.baseVerb && newCard.phrasalVerb.toLowerCase().startsWith(newCard.baseVerb.toLowerCase() + " ")) {
                        const particlePart = newCard.phrasalVerb.substring(newCard.baseVerb.length).trim().toLowerCase().replace(/\s+/g, '_');
                        if (particlePart) {
                            const particleTag = `particle_${particlePart}`;
                            if (!newCard.tags.includes(particleTag)) {
                                // newCard.tags.push(particleTag); // Decided against auto-adding particle tags for simplicity of user input
                            }
                        }
                    }

                } else {
                    newCard.word = word;
                }

                const allUserCards = loadUserCards();
                if (!allUserCards[category]) {
                    allUserCards[category] = [];
                }

                if (currentEditingCardId) { // Editing existing card
                    const cardIndex = allUserCards[category].findIndex(card => card.id === currentEditingCardId);
                    if (cardIndex > -1) {
                        // Before updating, check if the word/phrasal verb (identifier) has changed.
                        // If it has, we might need to update its status key in cardStatuses.
                        const oldIdentifier = getCardIdentifier(allUserCards[category][cardIndex], category);
                        const newIdentifier = getCardIdentifier(newCard, category);

                        if (oldIdentifier !== newIdentifier && cardStatuses[category] && cardStatuses[category][oldIdentifier]) {
                            cardStatuses[category][newIdentifier] = cardStatuses[category][oldIdentifier];
                            delete cardStatuses[category][oldIdentifier];
                            saveCardStatuses();
                        }
                        allUserCards[category][cardIndex] = newCard;
                    } else { // Should not happen if currentEditingCardId is set correctly
                        allUserCards[category].push(newCard); 
                    }
                } else { // Adding new card
                    // Check for duplicates based on word/phrasal verb for user cards in the same category
                    const existingCardIndex = allUserCards[category].findIndex(card => getCardIdentifier(card, category).toLowerCase() === getCardIdentifier(newCard, category).toLowerCase());
                    if (existingCardIndex > -1) {
                        if (!confirm("Một thẻ với Từ/Cụm từ này đã tồn tại. Bạn có muốn cập nhật thẻ đó không?")) {
                            return;
                        }
                        // If updating, use the existing card's ID
                        newCard.id = allUserCards[category][existingCardIndex].id;
                        allUserCards[category][existingCardIndex] = newCard;
                    } else {
                        allUserCards[category].push(newCard);
                    }
                }

                saveUserCards(allUserCards);
                closeAddEditModal();
                loadVocabularyData(category); // Reload data for the current category
                alert(currentEditingCardId ? "Đã cập nhật thẻ!" : "Đã thêm thẻ mới!");
                currentEditingCardId = null;
            }
            
            function handleDeleteCard() {
                if (currentData.length === 0 || !currentData[currentIndex].isUserCard) return;

                const cardToDelete = currentData[currentIndex];
                if (!confirm(`Bạn có chắc chắn muốn xóa thẻ "${getCardIdentifier(cardToDelete, categorySelect.value)}"?`)) {
                    return;
                }

                const category = categorySelect.value;
                const allUserCards = loadUserCards();

                if (allUserCards[category]) {
                    const cardIdentifierToDelete = getCardIdentifier(cardToDelete, category);
                    allUserCards[category] = allUserCards[category].filter(card => card.id !== cardToDelete.id);
                    
                    // Remove status for the deleted card
                    if (cardStatuses[category] && cardStatuses[category][cardIdentifierToDelete]) {
                        delete cardStatuses[category][cardIdentifierToDelete];
                        saveCardStatuses();
                    }
                    saveUserCards(allUserCards);
                }
                
                // Adjust current index and reload/refresh
                let newIndex = currentIndex;
                if (currentIndex === currentData.length - 1 && currentIndex > 0) { // If it was the last card
                    newIndex = currentIndex -1;
                }
                
                loadVocabularyData(category).then(() => {
                    // After data is reloaded and filtered, try to set the index
                    // This ensures currentData is up-to-date before accessing it
                    if (currentData.length > 0) {
                        currentIndex = Math.min(newIndex, currentData.length - 1);
                        if (currentIndex < 0) currentIndex = 0; // Ensure index is not negative
                    } else {
                        currentIndex = 0; // No data left
                    }
                    getCategoryState(category).currentIndex = currentIndex;
                    saveAppState();
                    updateFlashcard(); // This will refresh the display
                });
                alert("Đã xóa thẻ.");
            }


            // --- Utility Functions ---
            function shuffleArray(array) {
                const newArray = [...array]; 
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }
            
            // --- Text-to-Speech (TTS) ---
            function speakText(textToSpeak, metaForHighlighting = [], onEndCallback = null) {
                if (!textToSpeak || textToSpeak.trim() === '') {
                    if (onEndCallback) onEndCallback();
                    return;
                }
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'en-US'; utterance.rate = 0.9; utterance.pitch = 1;  
                    window.speechSynthesis.cancel();

                    if (metaForHighlighting.length > 0) {
                        utterance.onstart = () => metaForHighlighting.forEach(meta => meta.element.classList.remove('highlighted-word'));
                        utterance.onboundary = (event) => {
                            metaForHighlighting.forEach(meta => meta.element.classList.remove('highlighted-word'));
                            let foundWord = false;
                            for (const meta of metaForHighlighting) {
                                if (event.charIndex >= meta.start && event.charIndex < meta.start + meta.length) {
                                    meta.element.classList.add('highlighted-word'); foundWord = true; break;
                                }
                            }
                            if (!foundWord && metaForHighlighting.length > 0) {
                                for (let i = metaForHighlighting.length - 1; i >= 0; i--) {
                                    const meta = metaForHighlighting[i];
                                    if (event.charIndex >= meta.start) {
                                        if ( (i === metaForHighlighting.length -1) || (event.charIndex < metaForHighlighting[i+1].start) ) {
                                            meta.element.classList.add('highlighted-word'); break;
                                        }
                                    }
                                }
                            }
                        };
                        utterance.onend = () => {
                            metaForHighlighting.forEach(meta => meta.element.classList.remove('highlighted-word'));
                            if (onEndCallback) onEndCallback();
                        };
                        utterance.onerror = (event) => {
                            console.error('Lỗi Text-to-Speech:', event.error);
                            metaForHighlighting.forEach(meta => meta.element.classList.remove('highlighted-word'));
                            if (onEndCallback) onEndCallback(); 
                        };
                    } else {
                         utterance.onend = () => { if (onEndCallback) onEndCallback(); };
                         utterance.onerror = (event) => { console.error('Lỗi Text-to-Speech:', event.error); if (onEndCallback) onEndCallback(); };
                    }
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.warn('Trình duyệt không hỗ trợ TTS.');
                    if (onEndCallback) onEndCallback();
                }
            }

            function playNextExampleInQueue() {
                if (!isSpeakingExampleQueue || currentExampleSpeechIndex >= exampleSpeechQueue.length) {
                    isSpeakingExampleQueue = false; currentExampleSpeechIndex = 0; exampleSpeechQueue = [];
                    speakerExampleBtn.disabled = !(currentData[currentIndex] && currentData[currentIndex].example); 
                    return;
                }
                const part = exampleSpeechQueue[currentExampleSpeechIndex];
                speakText(part.text, part.spansMeta, () => { currentExampleSpeechIndex++; playNextExampleInQueue(); });
            }

            // --- Filter Population ---
            function populateBaseVerbFilter(dataArray) { // Changed parameter name for clarity
                const allBaseVerbs = new Set();
                dataArray.forEach(item => { if (item.baseVerb) allBaseVerbs.add(item.baseVerb); });
                baseVerbSelect.innerHTML = ''; 
                const allBVOption = document.createElement('option');
                allBVOption.value = 'all'; allBVOption.textContent = 'Tất cả từ gốc';
                baseVerbSelect.appendChild(allBVOption);
                const sortedBaseVerbs = Array.from(allBaseVerbs).sort((a,b) => a.localeCompare(b, 'en', {sensitivity: 'base'}));
                sortedBaseVerbs.forEach(verb => {
                    const option = document.createElement('option');
                    option.value = verb; option.textContent = verb.charAt(0).toUpperCase() + verb.slice(1); 
                    baseVerbSelect.appendChild(option);
                });
            }

            function populateTagFilter(dataArray) { // Changed parameter name
                const thematicTagsFromData = new Set(); 
                dataArray.forEach(item => {
                    if (item.tags && Array.isArray(item.tags)) {
                        item.tags.forEach(tag => {
                            if (tagDisplayNames[tag] && tag !== 'all' && !tag.startsWith('particle_')) {
                                thematicTagsFromData.add(tag);
                            }
                        });
                    }
                });
                tagSelect.innerHTML = ''; 
                const allTagOption = document.createElement('option');
                allTagOption.value = 'all'; allTagOption.textContent = tagDisplayNames["all"] || 'Tất cả chủ đề';
                tagSelect.appendChild(allTagOption);
                const sortedTagKeys = Array.from(thematicTagsFromData).sort((a, b) =>
                    (tagDisplayNames[a] || a).localeCompare(tagDisplayNames[b] || b, 'vi', { sensitivity: 'base' })
                );
                sortedTagKeys.forEach(tagKey => {
                    const option = document.createElement('option');
                    option.value = tagKey; option.textContent = tagDisplayNames[tagKey] || (tagKey.charAt(0).toUpperCase() + tagKey.slice(1)); 
                    tagSelect.appendChild(option);
                });
            }
            
            // --- Core Logic (Filtering, Data Loading, Flashcard Update) ---
            function applyAllFilters(calledFromLoadVocabulary = false) {
                clearLearningTimer(); 
                const currentCategoryValue = categorySelect.value;
                const categoryState = getCategoryState(currentCategoryValue); 
                let currentSearchTerm = searchInput.value.trim().toLowerCase(); 

                if (!calledFromLoadVocabulary) {
                    if (currentCategoryValue === 'phrasalVerbs') {
                        categoryState.baseVerb = baseVerbSelect.value;
                        categoryState.tag = tagSelect.value;
                    }
                    categoryState.filterMarked = filterCardStatusSelect.value; 
                    categoryState.currentIndex = 0;
                }

                let listToProcess = [...activeMasterList]; // activeMasterList now contains merged static + user cards

                if (currentCategoryValue === 'phrasalVerbs') {
                    if (categoryState.baseVerb && categoryState.baseVerb !== 'all') {
                        listToProcess = listToProcess.filter(item => item.baseVerb === categoryState.baseVerb);
                    }
                     if (categoryState.tag && categoryState.tag !== 'all') {
                        listToProcess = listToProcess.filter(item => item.tags && item.tags.includes(categoryState.tag));
                    }
                }
                
                if (currentSearchTerm) { 
                    listToProcess = listToProcess.filter(item => 
                        ((currentCategoryValue === 'phrasalVerbs' ? item.phrasalVerb : item.word) || '').toLowerCase().includes(currentSearchTerm)
                    );
                }
                
                const statusFilterValue = categoryState.filterMarked; 
                if (statusFilterValue !== 'all_visible') { 
                     listToProcess = listToProcess.filter(item => {
                        const identifier = getCardIdentifier(item, currentCategoryValue);
                        const status = getCardStatus(identifier, currentCategoryValue);
                        if (statusFilterValue === 'all_study') return status === 'new' || status === 'learning';
                        if (statusFilterValue === 'new') return status === 'new';
                        if (statusFilterValue === 'learning') return status === 'learning';
                        if (statusFilterValue === 'learned') return status === 'learned';
                        return true; 
                    });
                }
                
                currentData = listToProcess; 
                
                if (calledFromLoadVocabulary) {
                    currentIndex = categoryState.currentIndex || 0; 
                     if (currentIndex >= currentData.length) { 
                         currentIndex = currentData.length > 0 ? currentData.length - 1 : 0; // Ensure valid index
                    }
                } else {
                    currentIndex = 0;
                }
                categoryState.currentIndex = currentData.length > 0 ? currentIndex : 0; 

                saveAppState(); 
                updateFlashcard(); 
            }

            async function loadVocabularyData(category) {
                clearLearningTimer();
                wordDisplay.innerHTML = '<span class="text-slate-500">Đang tải...</span>';
                // Reset displays
                currentWordSpansMeta = []; pronunciationDisplay.textContent = ''; tagsDisplayFront.textContent = ''; 
                meaningDisplay.textContent = ''; exampleDisplay.innerHTML = ''; exampleVieDisplay.textContent = ''; notesDisplay.innerHTML = '';
                currentData = []; activeMasterList = []; 
                speakerBtn.disabled = true; speakerExampleBtn.disabled = true;
                
                const categoryState = getCategoryState(category); 
                searchInput.value = ''; 
                filterCardStatusSelect.value = categoryState.filterMarked; 
                updateSidebarFilterVisibility();
                
                baseVerbSelect.innerHTML = ''; tagSelect.innerHTML = ''; 
                if (category !== 'phrasalVerbs') {
                    if(appState.categoryStates[category]) { 
                        appState.categoryStates[category].baseVerb = 'all'; appState.categoryStates[category].tag = 'all';
                    }
                }
                updateCardInfo(); 

                try {
                    const response = await fetch(`data/${category}.json?v=${new Date().getTime()}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const jsonData = await response.json();
                    let staticData = (jsonData && jsonData[category]) ? jsonData[category].map(card => ({...card, isUserCard: false })) : [];
                    
                    // Load user cards and merge
                    const allUserCards = loadUserCards();
                    const userCardsForCategory = allUserCards[category] || [];
                    
                    // Combine and ensure user cards might override static ones if identifiers clash (though unlikely with good IDs)
                    // A more robust merge would check for duplicate identifiers if static cards could also have 'id'
                    activeMasterList = shuffleArray([...staticData, ...userCardsForCategory]); 
                    
                    if (category === 'phrasalVerbs') {
                        if (activeMasterList.length > 0) { 
                            populateBaseVerbFilter(activeMasterList); populateTagFilter(activeMasterList); 
                        }
                        baseVerbSelect.value = categoryState.baseVerb || 'all';
                        tagSelect.value = categoryState.tag || 'all';
                    }
                    applyAllFilters(true);
                } catch (error) {
                    console.error("Lỗi tải dữ liệu:", error);
                    wordDisplay.innerHTML = '<span class="text-red-500">Lỗi tải dữ liệu!</span>';
                    currentData = []; activeMasterList = [];
                    updateFlashcard(); 
                }
            }
            
            function displayMultipleChoiceOptions() {
                multipleChoiceOptionsContainer.innerHTML = ''; 
                feedbackMessage.textContent = '';
                feedbackMessage.className = 'mt-3 p-3 rounded-md w-full text-center font-semibold hidden'; 
                currentAnswerChecked = false; 

                if (currentData.length === 0) {
                    multipleChoiceOptionsContainer.innerHTML = '<p class="text-slate-500 col-span-full text-center">Không có thẻ để luyện tập.</p>'; return;
                }
                const currentItem = currentData[currentIndex]; const category = categorySelect.value;
                let options = []; 
                
                if (practiceType === 'meaning_quiz') { 
                    currentCorrectAnswerForPractice = currentItem.meaning || ''; options.push(currentCorrectAnswerForPractice);
                    const tempDistractorPool = activeMasterList.filter(item => 
                        item && item.meaning && item.meaning !== currentCorrectAnswerForPractice &&
                        getCardIdentifier(item, category) !== getCardIdentifier(currentItem, category)
                    );
                    const shuffledDistractorPool = shuffleArray(tempDistractorPool);
                    for (let i = 0; i < shuffledDistractorPool.length && options.length < 4; i++) {
                        const distractorMeaning = shuffledDistractorPool[i].meaning;
                        if (!options.includes(distractorMeaning)) options.push(distractorMeaning);
                    }
                } else if (practiceType === 'word_quiz') { 
                    currentCorrectAnswerForPractice = (category === 'phrasalVerbs' ? currentItem.phrasalVerb : currentItem.word) || '';
                    options.push(currentCorrectAnswerForPractice);
                    const tempDistractorPool = activeMasterList.filter(item => {
                        const itemWord = (category === 'phrasalVerbs' ? item.phrasalVerb : item.word);
                        return item && itemWord && itemWord !== currentCorrectAnswerForPractice && getCardIdentifier(item, category) !== getCardIdentifier(currentItem, category);
                    });
                    const shuffledDistractorPool = shuffleArray(tempDistractorPool);
                     for (let i = 0; i < shuffledDistractorPool.length && options.length < 4; i++) {
                        const distractorWord = (category === 'phrasalVerbs' ? shuffledDistractorPool[i].phrasalVerb : shuffledDistractorPool[i].word);
                        if (distractorWord && !options.includes(distractorWord)) options.push(distractorWord);
                    }
                }
                while(options.length < 2 && options.length > 0) options.push("Không có lựa chọn khác"); 
                if(options.length === 0 ) { 
                    let message = 'Không đủ dữ liệu cho luyện tập.';
                    if (currentData.length > 0 && currentData.filter(c => getCardStatus(getCardIdentifier(c, category), category) !== 'learned').length < 2) {
                         message = 'Cần ít nhất 2 thẻ chưa "Đã thuộc" để tạo câu hỏi.';
                    }
                    multipleChoiceOptionsContainer.innerHTML = `<p class="text-slate-500 col-span-full text-center">${message}</p>`; return;
                }
                const shuffledOptions = shuffleArray(options); 
                shuffledOptions.forEach(optionText => {
                    const button = document.createElement('button');
                    button.className = 'choice-button bg-white hover:bg-slate-100 text-slate-700 font-medium py-3 px-4 border border-slate-300 rounded-lg shadow-sm transition';
                    button.textContent = optionText;
                    button.addEventListener('click', () => { if (!currentAnswerChecked) checkMultipleChoiceAnswer(optionText, currentCorrectAnswerForPractice, button); });
                    multipleChoiceOptionsContainer.appendChild(button);
                });
                updateCardInfo(); 
            }

            function checkMultipleChoiceAnswer(selectedAnswer, correctAnswer, selectedButton) {
                currentAnswerChecked = true; feedbackMessage.classList.remove('hidden');
                const buttons = multipleChoiceOptionsContainer.querySelectorAll('.choice-button');
                buttons.forEach(btn => {
                    btn.disabled = true; btn.classList.remove('hover:bg-slate-100');
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('bg-green-500', 'text-white', 'border-green-600');
                        btn.classList.remove('bg-white', 'text-slate-700', 'border-slate-300');
                    }
                });
                const isCorrect = selectedAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase();
                if (isCorrect) { 
                    feedbackMessage.textContent = 'Đúng!'; 
                    feedbackMessage.className = 'mt-3 p-3 rounded-md w-full text-center font-semibold bg-green-100 text-green-700 border border-green-300'; 
                } else { 
                    feedbackMessage.textContent = `Sai! Đáp án đúng: ${correctAnswer}`; 
                    feedbackMessage.className = 'mt-3 p-3 rounded-md w-full text-center font-semibold bg-red-100 text-red-700 border border-red-300'; 
                    if(selectedButton.textContent !== correctAnswer) {
                        selectedButton.classList.add('bg-red-500', 'text-white', 'border-red-600');
                        selectedButton.classList.remove('bg-white', 'text-slate-700', 'border-slate-300', 'bg-green-500', 'border-green-600');
                    }
                }
                flashcard.classList.remove('practice-mode-front-only'); flashcard.classList.add('flipped'); 
                const item = currentData[currentIndex]; const categoryValue = categorySelect.value;
                const cardIdentifier = getCardIdentifier(item, categoryValue);
                if(cardIdentifier) {
                    if (!cardStatuses[categoryValue]) cardStatuses[categoryValue] = {};
                    const newCardStatus = isCorrect ? 'learned' : 'learning'; 
                    cardStatuses[categoryValue][cardIdentifier] = newCardStatus;
                    saveCardStatuses(); updateStatusButtonsUI(cardIdentifier, categoryValue);
                    if (newCardStatus === 'learned' && getCategoryState(categoryValue).filterMarked === 'all_study') applyAllFilters(); 
                }
                updateCardInfo(); 
            }

            function checkTypingAnswer() {
                if (currentData.length === 0 || !currentCorrectAnswerForPractice) return;
                currentAnswerChecked = true; feedbackMessage.classList.remove('hidden');
                typingInput.disabled = true; submitTypingAnswerBtn.disabled = true;
                const userAnswer = typingInput.value.trim().toLowerCase();
                const correctAnswer = currentCorrectAnswerForPractice.trim().toLowerCase();
                const isCorrect = userAnswer === correctAnswer;
                if (isCorrect) {
                    feedbackMessage.textContent = 'Đúng!';
                    feedbackMessage.className = 'mt-3 p-3 rounded-md w-full text-center font-semibold bg-green-100 text-green-700 border border-green-300';
                } else {
                    feedbackMessage.textContent = `Sai! Đáp án đúng: ${currentCorrectAnswerForPractice}`;
                    feedbackMessage.className = 'mt-3 p-3 rounded-md w-full text-center font-semibold bg-red-100 text-red-700 border border-red-300';
                }
                flashcard.classList.remove('practice-mode-front-only'); flashcard.classList.add('flipped');
                const item = currentData[currentIndex]; const categoryValue = categorySelect.value;
                const cardIdentifier = getCardIdentifier(item, categoryValue);
                if (cardIdentifier) {
                    if (!cardStatuses[categoryValue]) cardStatuses[categoryValue] = {};
                    const newCardStatus = isCorrect ? 'learned' : 'learning';
                    cardStatuses[categoryValue][cardIdentifier] = newCardStatus;
                    saveCardStatuses(); updateStatusButtonsUI(cardIdentifier, categoryValue);
                    if (newCardStatus === 'learned' && getCategoryState(categoryValue).filterMarked === 'all_study') applyAllFilters();
                }
                updateCardInfo();
            }

            function updateFlashcard() {
                clearLearningTimer(); 
                const currentCategoryValue = categorySelect.value;
                currentAnswerChecked = false; 
                feedbackMessage.textContent = ''; feedbackMessage.className = 'mt-3 p-3 rounded-md w-full text-center font-semibold hidden';
                multipleChoiceOptionsContainer.innerHTML = ''; 
                typingInputContainer.style.display = 'none'; typingInput.value = ''; typingInput.disabled = false; submitTypingAnswerBtn.disabled = false;

                pronunciationDisplay.style.display = 'block'; tagsDisplayFront.style.display = 'block'; 
                speakerBtn.style.display = 'block'; speakerExampleBtn.style.display = 'block';
                flipBtn.style.display = 'inline-flex'; 
                flashcard.classList.remove('practice-mode-word-quiz'); 

                if (practiceType !== "off") {
                    flipBtn.style.display = 'none'; practiceArea.style.display = 'flex'; 
                    flashcard.classList.add('practice-mode-front-only'); flashcard.classList.remove('flipped'); 
                    if (practiceType === 'typing_practice') {
                        typingInputContainer.style.display = 'block'; multipleChoiceOptionsContainer.style.display = 'none';
                        if (currentData.length > 0) {
                             const currentItem = currentData[currentIndex];
                             currentCorrectAnswerForPractice = (currentCategoryValue === 'phrasalVerbs' ? currentItem.phrasalVerb : currentItem.word) || '';
                        } else typingInputContainer.innerHTML = '<p class="text-slate-500 text-center">Không có thẻ để luyện tập.</p>';
                    } else { 
                        typingInputContainer.style.display = 'none'; multipleChoiceOptionsContainer.style.display = 'grid';
                         if (currentData.length > 0) displayMultipleChoiceOptions();
                         else multipleChoiceOptionsContainer.innerHTML = '<p class="text-slate-500 col-span-full text-center">Không có thẻ với bộ lọc này.</p>';
                    }
                    if (practiceType === 'word_quiz') { 
                        pronunciationDisplay.style.display = 'none'; tagsDisplayFront.style.display = 'none'; 
                        speakerBtn.style.display = 'none'; flashcard.classList.add('practice-mode-word-quiz');
                    }
                } else {
                    practiceArea.style.display = 'none'; 
                    flashcard.classList.remove('practice-mode-front-only'); flashcard.classList.remove('flipped'); 
                }

                if (currentData.length === 0) {
                    let statusText = 'Không có từ nào phù hợp.';
                    if (activeMasterList.length === 0 && !(searchInput.value.trim() && wordDisplay.firstChild && (wordDisplay.firstChild.textContent.includes('Lỗi') || wordDisplay.firstChild.textContent.includes('Đang tải')))) {
                        statusText = 'Chọn loại từ để bắt đầu hoặc thêm thẻ mới.';
                    } else if (searchInput.value.trim() && wordDisplay.firstChild && (wordDisplay.firstChild.textContent.includes('Lỗi') || wordDisplay.firstChild.textContent.includes('Đang tải'))) {
                        statusText = wordDisplay.firstChild.textContent;
                    } else if (searchInput.value.trim() && activeMasterList.length > 0) { 
                        statusText = 'Không tìm thấy từ nào khớp.';
                    } else if (wordDisplay.firstChild && (wordDisplay.firstChild.textContent.includes('Lỗi') || wordDisplay.firstChild.textContent.includes('Đang tải'))) {
                         statusText = wordDisplay.firstChild.textContent;
                     }
                    wordDisplay.innerHTML = ''; 
                    const statusSpan = document.createElement('span');
                    statusSpan.className = statusText.includes('Lỗi') ? 'text-red-500' : 'text-slate-500';
                    statusSpan.textContent = statusText;
                    wordDisplay.appendChild(statusSpan);
                    pronunciationDisplay.textContent = ''; tagsDisplayFront.textContent = ''; 
                    meaningDisplay.textContent = ''; exampleDisplay.innerHTML = ''; exampleVieDisplay.textContent = ''; notesDisplay.innerHTML = '';
                    speakerBtn.disabled = true; speakerExampleBtn.disabled = true;
                    updateStatusButtonsUI(null, null); 
                } else {
                    const item = currentData[currentIndex]; let textForTTS; 
                    wordDisplay.innerHTML = ''; currentWordSpansMeta = []; let accumulatedCharCount = 0;

                    if (practiceType === 'word_quiz') { 
                        textForTTS = item.meaning || '';
                        const mainTextSpan = document.createElement('span'); mainTextSpan.className = 'main-phrasal-verb-text';
                        const segments = textForTTS.split(/(\s+)/);
                        segments.forEach(segment => {
                            if (segment.trim() !== '') {
                                const wordSpan = document.createElement('span'); wordSpan.textContent = segment;
                                mainTextSpan.appendChild(wordSpan);
                                currentWordSpansMeta.push({ element: wordSpan, start: accumulatedCharCount, length: segment.length });
                            } else mainTextSpan.appendChild(document.createTextNode(segment));
                            accumulatedCharCount += segment.length;
                        });
                        wordDisplay.appendChild(mainTextSpan);
                    } else { 
                        const originalText = (currentCategoryValue === 'phrasalVerbs') ? (item.phrasalVerb || '') : (item.word || '');
                        textForTTS = originalText; 
                        const parts = originalText.split(/(\([^)]+\))/g).filter(part => part); 
                        parts.forEach(part => {
                            const isDetail = part.startsWith('(') && part.endsWith(')');
                            const containerSpan = document.createElement('span');
                            containerSpan.className = isDetail ? 'text-xl sm:text-2xl font-normal text-green-100 opacity-80 ml-1 mr-1' : 'text-3xl sm:text-4xl font-bold';
                            const segments = part.split(/(\s+)/);
                            segments.forEach(segment => {
                                if (segment.trim() !== '') {
                                    const wordSpan = document.createElement('span'); wordSpan.textContent = segment;
                                    containerSpan.appendChild(wordSpan);
                                    currentWordSpansMeta.push({ element: wordSpan, start: accumulatedCharCount, length: segment.length });
                                } else {
                                     if (wordDisplay.childNodes.length > 0 || containerSpan.childNodes.length > 0) containerSpan.appendChild(document.createTextNode(segment));
                                     else if (segment !== ' ') containerSpan.appendChild(document.createTextNode(segment));
                                }
                                accumulatedCharCount += segment.length;
                            });
                            wordDisplay.appendChild(containerSpan);
                            if (!isDetail && parts.length > 1 && parts.indexOf(part) < parts.length -1 && !(parts[parts.indexOf(part)+1].startsWith('(') && parts[parts.indexOf(part)+1].endsWith(')'))) {
                                wordDisplay.appendChild(document.createTextNode(' ')); accumulatedCharCount++;
                            }
                        });
                    }
                    pronunciationDisplay.textContent = item.pronunciation || '';
                    if (currentCategoryValue === 'phrasalVerbs' && item.tags && practiceType !== 'word_quiz') {
                        const displayableTags = item.tags.filter(tag => tag !== 'all' && !tag.startsWith('particle_') && tagDisplayNames[tag]).map(tag => tagDisplayNames[tag]);
                        tagsDisplayFront.textContent = displayableTags.join(' | ');
                        tagsDisplayFront.style.display = displayableTags.length > 0 ? 'block' : 'none';
                    } else { tagsDisplayFront.textContent = ''; tagsDisplayFront.style.display = 'none'; }
                    meaningDisplay.textContent = item.meaning || '';
                    const exampleTextFromData = (item.example || '').replace(/^Ví dụ:\s*/i, '').trim();
                    exampleDisplay.innerHTML = ''; 
                    if (exampleTextFromData) {
                        const sentences = exampleTextFromData.split(/\s*\/\s*/); 
                        sentences.forEach((sentence, index) => {
                            const sentenceSpan = document.createElement('span'); sentenceSpan.classList.add('example-sentence-part');
                            const wordsInSentence = sentence.split(/(\s+)/); 
                            wordsInSentence.forEach(wordSegment => {
                                if (wordSegment.trim() !== '') {
                                    const wordSpan = document.createElement('span'); wordSpan.textContent = wordSegment;
                                    sentenceSpan.appendChild(wordSpan);
                                } else sentenceSpan.appendChild(document.createTextNode(wordSegment));
                            });
                            exampleDisplay.appendChild(sentenceSpan);
                            if (index < sentences.length - 1) { 
                                const separatorSpan = document.createElement('span'); separatorSpan.className = 'text-indigo-300 mx-1'; 
                                separatorSpan.textContent = '/'; exampleDisplay.appendChild(separatorSpan);
                            }
                        });
                    }
                    exampleVieDisplay.textContent = item.exampleVie ? `(${item.exampleVie})` : ''; 
                    let notesText = item.notes ? `Ghi chú: ${item.notes}` : '';
                    if (currentCategoryValue === 'phrasalVerbs' && item.baseVerb) {
                        const baseVerbNote = `Động từ gốc: ${item.baseVerb}`;
                        notesText = notesText ? `${baseVerbNote}<br>${notesText}` : baseVerbNote; 
                    }
                    notesDisplay.innerHTML = notesText; 
                    speakerBtn.disabled = !textForTTS.trim() || (practiceType === 'word_quiz'); 
                    speakerExampleBtn.disabled = !exampleTextFromData; 
                    const cardIdentifierForStatus = getCardIdentifier(item, currentCategoryValue);
                    updateStatusButtonsUI(cardIdentifierForStatus, currentCategoryValue);
                }
                updateCardInfo(); 
                if (practiceType === 'off') startLearningTimer();
            }

            function updateCardInfo() {
                currentCardIndexDisplay.textContent = currentData.length > 0 ? currentIndex + 1 : 0;
                totalCardsDisplay.textContent = currentData.length;
                prevBtn.disabled = currentIndex === 0 || currentData.length === 0;
                let nextButtonShouldBeDisabled = (currentIndex >= currentData.length - 1 || currentData.length === 0);
                if (practiceType !== "off") { 
                    nextButtonShouldBeDisabled = nextButtonShouldBeDisabled || (!currentAnswerChecked && currentData.length > 0) || (currentData.length > 0 && currentIndex >= currentData.length -1 && !currentAnswerChecked) ;
                }
                if (!learningCardNextButtonTimer) nextBtn.disabled = nextButtonShouldBeDisabled;
                flipBtn.disabled = currentData.length === 0 || (practiceType !== "off"); 
            }
            
            // --- Event Handlers ---
            function setupEventListeners() {
                hamburgerMenuBtn.addEventListener('click', openSidebar);
                closeSidebarBtn.addEventListener('click', closeSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);

                openAddCardModalBtn.addEventListener('click', () => openAddEditModal('add'));
                closeModalBtn.addEventListener('click', closeAddEditModal);
                cancelCardBtn.addEventListener('click', closeAddEditModal);
                addEditCardForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSaveCard();
                });

                editCardBtn.addEventListener('click', () => {
                    if (currentData.length > 0 && currentData[currentIndex] && currentData[currentIndex].isUserCard) {
                        openAddEditModal('edit', currentData[currentIndex]);
                    }
                });
                deleteCardBtn.addEventListener('click', handleDeleteCard);


                practiceTypeSelect.addEventListener('change', (e) => {
                    clearLearningTimer(); practiceType = e.target.value;
                    const categoryState = getCategoryState(categorySelect.value);
                    searchInput.value = ''; 
                    if (categorySelect.value === 'phrasalVerbs') { 
                        categoryState.tag = 'all'; tagSelect.value = 'all'; 
                        categoryState.baseVerb = 'all'; baseVerbSelect.value = 'all';
                    }
                    categoryState.filterMarked = 'all_study'; filterCardStatusSelect.value = 'all_study';
                    categoryState.currentIndex = 0; 
                    applyAllFilters(); closeSidebar(); 
                });

                categorySelect.addEventListener('change', (e) => {
                    clearLearningTimer(); const selectedCategory = e.target.value;
                    practiceTypeSelect.value = "off"; practiceType = "off";
                    appState.lastSelectedCategory = selectedCategory; searchInput.value = ''; 
                    loadVocabularyData(selectedCategory); updateSidebarFilterVisibility(); 
                });

                baseVerbSelect.addEventListener('change', applyAllFilters);
                tagSelect.addEventListener('change', applyAllFilters);
                searchInput.addEventListener('input', applyAllFilters); 
                filterCardStatusSelect.addEventListener('change', applyAllFilters);

                flipBtn.addEventListener('click', () => { if (practiceType === "off" && currentData.length > 0) flashcard.classList.toggle('flipped'); });
                flashcard.addEventListener('click', (event) => {
                    if (practiceType === "off" && event.target.closest('.flashcard') === flashcard &&
                        !event.target.closest('button#speaker-btn') && !event.target.closest('button#speaker-example-btn') ) { 
                        flashcard.classList.toggle('flipped');
                    }
                });

                nextBtn.addEventListener('click', () => { 
                    if (isSpeakingExampleQueue) { 
                        isSpeakingExampleQueue = false; window.speechSynthesis.cancel();
                        speakerExampleBtn.disabled = !(currentData[currentIndex] && currentData[currentIndex].example);
                    }
                    if (nextBtn.disabled) return; 
                    clearLearningTimer(); 
                    if (currentIndex < currentData.length - 1) { 
                        currentIndex++; getCategoryState(categorySelect.value).currentIndex = currentIndex; 
                        saveAppState(); updateFlashcard(); 
                    } else if (practiceType !== "off" && currentAnswerChecked && currentIndex >= currentData.length -1) {
                        applyAllFilters(); 
                    }
                });
                prevBtn.addEventListener('click', () => { 
                     if (isSpeakingExampleQueue) { 
                        isSpeakingExampleQueue = false; window.speechSynthesis.cancel();
                        speakerExampleBtn.disabled = !(currentData[currentIndex] && currentData[currentIndex].example);
                    }
                    clearLearningTimer();
                    if (currentIndex > 0) { 
                        currentIndex--; getCategoryState(categorySelect.value).currentIndex = currentIndex; 
                        saveAppState(); updateFlashcard(); 
                    } 
                });
                
                speakerBtn.addEventListener('click', (event) => {
                    event.stopPropagation(); 
                    if (isSpeakingExampleQueue) {
                        isSpeakingExampleQueue = false; window.speechSynthesis.cancel();
                        speakerExampleBtn.disabled = !(currentData[currentIndex] && currentData[currentIndex].example);
                    }
                    const textForSpeech = Array.from(wordDisplay.childNodes).map(node => node.textContent).join('').replace(/\s+/g, ' ').trim();
                    if (textForSpeech && !speakerBtn.disabled) speakText(textForSpeech, currentWordSpansMeta);
                });

                speakerExampleBtn.addEventListener('click', (event) => {
                    event.stopPropagation(); window.speechSynthesis.cancel(); 
                    isSpeakingExampleQueue = false; currentExampleSpeechIndex = 0; exampleSpeechQueue = [];
                    const item = currentData[currentIndex];
                    if (item && item.example && !speakerExampleBtn.disabled) {
                        const exampleSentenceElements = exampleDisplay.querySelectorAll('.example-sentence-part');
                        if (exampleSentenceElements.length > 0) {
                            exampleSentenceElements.forEach(sentenceEl => {
                                const text = sentenceEl.textContent.trim(); 
                                if (text) {
                                    const wordSpansMetaForSentence = []; let charIdxInSentence = 0;
                                    const wordSpansInSentenceDOM = sentenceEl.querySelectorAll('span'); 
                                    const wordsAndSpacesInSentence = sentenceEl.textContent.split(/(\s+)/);
                                    let domWordSpanIndex = 0;
                                    wordsAndSpacesInSentence.forEach(segment => {
                                        if (segment.trim() !== '') { 
                                            if (wordSpansInSentenceDOM[domWordSpanIndex]) {
                                                wordSpansMetaForSentence.push({element: wordSpansInSentenceDOM[domWordSpanIndex], start: charIdxInSentence, length: segment.length});
                                            }
                                            domWordSpanIndex++;
                                        }
                                        charIdxInSentence += segment.length;
                                    });
                                    exampleSpeechQueue.push({ text: text, spansMeta: wordSpansMetaForSentence });
                                }
                            });
                            if (exampleSpeechQueue.length > 0) {
                                isSpeakingExampleQueue = true; speakerExampleBtn.disabled = true; 
                                playNextExampleInQueue();
                            }
                        }
                    }
                });
                
                statusBtnNew.addEventListener('click', () => setCardStatus('new'));
                statusBtnLearning.addEventListener('click', () => setCardStatus('learning'));
                statusBtnLearned.addEventListener('click', () => setCardStatus('learned'));

                submitTypingAnswerBtn.addEventListener('click', checkTypingAnswer);
                typingInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && practiceType === 'typing_practice' && !submitTypingAnswerBtn.disabled) checkTypingAnswer(); });
            }

            function setupInitialCategory() {
                categorySelect.value = appState.lastSelectedCategory || 'phrasalVerbs'; 
                loadVocabularyData(categorySelect.value); 
            }
        });
    </script>
</body>
</html>
