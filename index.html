<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Flashcard Tiếng Anh (Nâng cấp)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', Arial, sans-serif;
        }
        .flashcard-container {
            perspective: 1000px;
        }
        .flashcard {
            transform-style: preserve-3d;
            transition: transform 0.7s;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        .flashcard.practice-mode-front-only {
            transform: rotateY(0deg) !important;
            cursor: default;
        }
        .card-scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        .card-scrollable-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .card-scrollable-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
        }
        .card-scrollable-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        .highlighted-word {
            background-color: #fef08a;
            color: #1f2937 !important;
            padding: 1px 3px;
            border-radius: 3px;
            box-shadow: 0 0 5px rgba(254, 240, 138, 0.5);
        }
        #filter-sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #speaker-btn, #speaker-example-btn {
            z-index: 10;
        }
        #typing-input::placeholder {
            color: #9ca3af;
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-content {
            transition: transform 0.25s ease;
        }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          }
        }
      }
    </script>
</head>
<body class="bg-slate-100 text-slate-800 flex flex-col min-h-screen">

    <header class="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <button id="hamburger-menu-btn" title="Mở bộ lọc" class="text-2xl p-2 hover:bg-slate-700 rounded-md">
                <i class="fas fa-bars"></i>
            </button>
            <h1 id="main-header-title" class="text-xl sm:text-2xl font-semibold text-center flex-grow">Flashcard - Thẻ của Web</h1>
            <div class="w-10 h-10"></div>
        </div>
    </header>

    <aside id="filter-sidebar" class="fixed top-0 left-0 w-72 h-full bg-white shadow-xl p-5 transform -translate-x-full z-[1001] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold text-slate-700">Tùy chọn</h2>
            <button id="close-sidebar-btn" title="Đóng bộ lọc" class="text-2xl text-slate-500 hover:text-slate-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <section class="controls space-y-5">
            <div>
                <label for="card-source-select" class="block text-sm font-medium text-slate-600 mb-1">Nguồn thẻ:</label>
                <select id="card-source-select" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="web">Thẻ của Web</option>
                    <option value="user">Thẻ của Tôi</option>
                </select>
            </div>

            <div>
                <button id="open-add-card-modal-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out mb-4">
                    <i class="fas fa-plus mr-2"></i>Thêm thẻ mới (vào "Thẻ của Tôi")
                </button>
            </div>
            <div class="control-group category-selection">
                <label for="category" class="block text-sm font-medium text-slate-600 mb-1">Chọn loại từ:</label>
                <select id="category" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="verbs">Động từ</option>
                    <option value="adjectives">Tính từ</option>
                    <option value="nouns">Danh từ</option>
                    <option value="phrasalVerbs">Cụm động từ</option>
                </select>
            </div>

            <div id="base-verb-filter-container" class="control-group base-verb-filter" style="display:none;">
                <label for="base-verb-filter" class="block text-sm font-medium text-slate-600 mb-1">Lọc theo từ gốc:</label>
                <select id="base-verb-filter" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>

            <div id="tag-filter-container" class="control-group tag-filter" style="display:none;">
                <label for="tags" class="block text-sm font-medium text-slate-600 mb-1">Lọc theo chủ đề:</label>
                <select id="tags" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
            </div>

            <div class="control-group practice-mode-selection">
                <label for="practice-type-select" class="block text-sm font-medium text-slate-600 mb-1">Chế độ Luyện tập:</label>
                <select id="practice-type-select" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="off">Tắt luyện tập</option>
                    <option value="meaning_quiz">Luyện tập: Chọn Nghĩa</option>
                    <option value="word_quiz">Luyện tập: Chọn Từ</option>
                    <option value="typing_practice">Luyện tập: Gõ Từ/Cụm từ</option>
                </select>
            </div>

            <div class="control-group card-status-filter">
                <label for="filter-card-status" class="block text-sm font-medium text-slate-600 mb-1">Hiển thị thẻ:</label>
                <select id="filter-card-status" class="w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="all_study">Từ mới & Đang học</option>
                    <option value="all_visible">Tất cả (gồm Đã thuộc)</option>
                    <option value="new">Chỉ Từ mới</option>
                    <option value="learning">Chỉ Đang học</option>
                    <option value="learned">Chỉ Đã thuộc</option>
                </select>
            </div>
        </section>
    </aside>
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-[1000] hidden"></div>

    <main class="container mx-auto p-4 sm:p-6 flex-grow w-full max-w-2xl flex flex-col items-center">
        <section class="search-filter-main-container w-full mb-4">
            <div class="control-group bg-white p-3 rounded-lg shadow">
                <label for="search-input" class="sr-only">Tìm kiếm:</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-slate-400"></i>
                    </div>
                    <input type="search" id="search-input" placeholder="Nhập từ tiếng Anh..." class="w-full p-3 pl-10 border border-slate-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </section>

        <section id="practice-area" class="practice-mode-controls w-full mb-4" style="display:none;">
            <div id="typing-input-container" class="w-full mb-2" style="display:none;">
                 <input type="text" id="typing-input" placeholder="Gõ câu trả lời của bạn..." class="w-full p-3 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-slate-700 bg-white">
                 <button id="submit-typing-answer-btn" class="mt-2 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-md shadow-md transition duration-150 ease-in-out">Kiểm tra</button>
            </div>
            <div id="multiple-choice-options" class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full"></div>
            <div id="feedback-message" class="mt-3 p-3 rounded-md w-full text-center font-semibold hidden"></div>
        </section>

        <section class="flashcard-container w-full h-[380px] sm:h-[400px] mb-4">
            <div id="flashcard" class="flashcard relative w-full h-full">
                <div class="card-front absolute w-full h-full bg-gradient-to-br from-green-500 to-emerald-600 text-white rounded-xl shadow-xl p-5 flex flex-col items-center justify-center overflow-hidden">
                    <div class="card-scrollable-content w-full h-full overflow-y-auto flex flex-col items-center justify-center text-center p-2 pb-16">
                        <div id="word-display" class="text-3xl sm:text-4xl font-bold break-words"></div>
                        <p id="pronunciation-display" class="pronunciation text-lg sm:text-xl text-green-100 mt-2 bg-black bg-opacity-20 px-3 py-1 rounded-md"></p>
                        <div id="tags-display-front" class="tags-front text-sm text-green-200 mt-3 italic"></div>
                    </div>
                    <button id="speaker-btn" title="Phát âm Từ/Cụm từ" class="absolute bottom-4 left-4 text-2xl sm:text-3xl text-white hover:text-green-200 transition-colors p-2 rounded-full hover:bg-black hover:bg-opacity-20">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
                <div class="card-back absolute w-full h-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white rounded-xl shadow-xl p-5 flex flex-col items-center overflow-hidden">
                    <div class="card-scrollable-content w-full h-full overflow-y-auto text-left p-2 pb-16 space-y-3">
                        <div class="meaning-section bg-black bg-opacity-20 p-3 rounded-lg">
                            <p id="meaning-display" class="text-xl sm:text-2xl font-semibold"></p>
                        </div>
                        <div class="example-section border-t border-blue-400 pt-3">
                            <p class="text-sm font-medium text-indigo-200 mb-1">Ví dụ (Tiếng Anh):</p>
                            <p id="example-display" class="example text-base sm:text-lg bg-black bg-opacity-10 p-2 rounded-md"></p>
                        </div>
                        <div class="example-vie-section border-t border-blue-400 pt-3">
                             <p class="text-sm font-medium text-indigo-200 mb-1">Nghĩa ví dụ (Tiếng Việt):</p>
                            <p id="example-vie-display" class="example-vie text-base sm:text-lg italic text-indigo-100"></p>
                        </div>
                        <div class="notes-section border-t border-blue-400 pt-3">
                            <p id="notes-display" class="notes text-sm text-indigo-200"></p>
                        </div>
                    </div>
                     <button id="speaker-example-btn" title="Phát âm Ví dụ" class="absolute bottom-4 right-4 text-2xl sm:text-3xl text-white hover:text-indigo-200 transition-colors p-2 rounded-full hover:bg-black hover:bg-opacity-20">
                        <i class="fas fa-volume-up"></i>
                    </button>
                </div>
            </div>
        </section>

        <section class="status-controls grid grid-cols-3 gap-2 sm:gap-3 w-full max-w-md mb-2">
            <button id="btn-status-new" class="py-2 px-3 sm:py-3 sm:px-4 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-md shadow-sm border border-slate-300 transition duration-150 ease-in-out">Từ mới</button>
            <button id="btn-status-learning" class="py-2 px-3 sm:py-3 sm:px-4 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-md shadow-sm border border-slate-300 transition duration-150 ease-in-out">Đang học</button>
            <button id="btn-status-learned" class="py-2 px-3 sm:py-3 sm:px-4 bg-white hover:bg-slate-50 text-slate-700 font-semibold rounded-md shadow-sm border border-slate-300 transition duration-150 ease-in-out">Đã thuộc</button>
        </section>
        
        <section id="user-card-actions" class="flex justify-center gap-2 sm:gap-3 w-full max-w-md mb-4" style="display: none;">
            <button id="edit-card-btn" class="py-2 px-4 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-md shadow-sm transition duration-150 ease-in-out">
                <i class="fas fa-edit mr-1"></i> Sửa thẻ này
            </button>
            <button id="delete-card-btn" class="py-2 px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-md shadow-sm transition duration-150 ease-in-out">
                <i class="fas fa-trash-alt mr-1"></i> Xóa thẻ này
            </button>
        </section>


        <section class="navigation flex justify-between items-center w-full max-w-md mb-4">
            <button id="prev-btn" class="py-3 px-6 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-arrow-left mr-1"></i> Trước
            </button>
            <button id="flip-btn" class="py-3 px-6 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-sync-alt mr-1"></i> Lật thẻ
            </button>
            <button id="next-btn" class="py-3 px-6 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Tiếp <i class="fas fa-arrow-right ml-1"></i>
            </button>
        </section>

        <section class="card-info text-center text-slate-600 text-sm mb-6">
            <p>Thẻ <span id="current-card-index" class="font-semibold">0</span> / <span id="total-cards" class="font-semibold">0</span></p>
        </section>
    </main>

    <footer class="bg-slate-800 text-white p-4 text-center mt-auto">
        <p>&copy; 2025 Flashcard App</p>
    </footer>

    <div id="add-edit-card-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-[1002] hidden opacity-0">
        <div class="modal-content bg-white p-6 sm:p-8 rounded-lg shadow-xl w-11/12 max-w-lg mx-auto transform scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-semibold text-slate-700">Thêm thẻ mới</h2>
                <button id="close-modal-btn" class="text-2xl text-slate-500 hover:text-slate-700">&times;</button>
            </div>
            <form id="add-edit-card-form" class="space-y-4">
                <input type="hidden" id="card-id-input"> <div>
                    <label for="card-word-input" class="block text-sm font-medium text-slate-600">Từ/Cụm từ (Tiếng Anh) <span class="text-red-500">*</span></label>
                    <input type="text" id="card-word-input" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="card-pronunciation-input" class="block text-sm font-medium text-slate-600">Phát âm</label>
                    <input type="text" id="card-pronunciation-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="card-meaning-input" class="block text-sm font-medium text-slate-600">Nghĩa (Tiếng Việt) <span class="text-red-500">*</span></label>
                    <input type="text" id="card-meaning-input" required class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="card-example-input" class="block text-sm font-medium text-slate-600">Câu ví dụ (Tiếng Anh)</label>
                    <textarea id="card-example-input" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div>
                    <label for="card-example-vie-input" class="block text-sm font-medium text-slate-600">Nghĩa câu ví dụ (Tiếng Việt)</label>
                    <textarea id="card-example-vie-input" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                 <div>
                    <label for="card-notes-input" class="block text-sm font-medium text-slate-600">Ghi chú</label>
                    <textarea id="card-notes-input" rows="2" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                <div id="phrasal-verb-specific-fields" style="display: none;">
                    <div>
                        <label for="card-base-verb-input" class="block text-sm font-medium text-slate-600">Động từ gốc (Base Verb)</label>
                        <input type="text" id="card-base-verb-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: get, put, take...">
                    </div>
                    <div>
                        <label for="card-tags-input" class="block text-sm font-medium text-slate-600">Chủ đề (Tags - cách nhau bởi dấu phẩy)</label>
                        <input type="text" id="card-tags-input" class="mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ví dụ: actions_general, communication...">
                        <p class="mt-1 text-xs text-slate-500">Xem danh sách tags gợi ý trong Bộ lọc.</p>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-card-btn" class="py-2 px-4 bg-slate-200 hover:bg-slate-300 text-slate-700 font-medium rounded-md shadow-sm">Hủy</button>
                    <button type="submit" id="save-card-btn" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-md shadow-md">Lưu thẻ</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const tagDisplayNames = {
            "all": "Tất cả chủ đề", 
            "actions_general": "Hành động chung", "actions_tasks": "Hành động & Nhiệm vụ", 
            "movement_travel": "Di chuyển & Du lịch", "communication": "Giao tiếp", 
            "relationships_social": "Quan hệ & Xã hội", "emotions_feelings": "Cảm xúc & Cảm giác", 
            "problems_solutions": "Vấn đề & Giải pháp", "work_business": "Công việc & Kinh doanh", 
            "learning_information": "Học tập & Thông tin", "daily_routine": "Thói quen hàng ngày", 
            "health_wellbeing": "Sức khỏe & Tinh thần", "objects_possession": "Đồ vật & Sở hữu", 
            "time_planning": "Thời gian & Kế hoạch", "money_finance": "Tiền bạc & Tài chính", 
            "behavior_attitude": "Hành vi & Thái độ", "begin_end_change": "Bắt đầu, Kết thúc & Thay đổi", 
            "food_drink": "Ăn uống", "home_living": "Nhà cửa & Đời sống", 
            "rules_systems": "Quy tắc & Hệ thống", "effort_achievement": "Nỗ lực & Thành tựu", 
            "safety_danger": "An toàn & Nguy hiểm", "technology": "Công nghệ", 
            "nature": "Thiên nhiên & Thời tiết", "art_creation": "Nghệ thuật & Sáng tạo" 
        };

        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const mainHeaderTitle = document.getElementById('main-header-title');
            const cardSourceSelect = document.getElementById('card-source-select');
            const categorySelect = document.getElementById('category');
            const flashcard = document.getElementById('flashcard');
            const wordDisplay = document.getElementById('word-display');
            const pronunciationDisplay = document.getElementById('pronunciation-display');
            const meaningDisplay = document.getElementById('meaning-display');
            const exampleDisplay = document.getElementById('example-display');
            const exampleVieDisplay = document.getElementById('example-vie-display');
            const notesDisplay = document.getElementById('notes-display');
            const prevBtn = document.getElementById('prev-btn');
            const flipBtn = document.getElementById('flip-btn');
            const nextBtn = document.getElementById('next-btn');
            const currentCardIndexDisplay = document.getElementById('current-card-index');
            const totalCardsDisplay = document.getElementById('total-cards');
            const speakerBtn = document.getElementById('speaker-btn');
            const speakerExampleBtn = document.getElementById('speaker-example-btn');
            const tagFilterContainer = document.getElementById('tag-filter-container');
            const tagSelect = document.getElementById('tags');
            const searchInput = document.getElementById('search-input');
            const baseVerbFilterContainer = document.getElementById('base-verb-filter-container');
            const baseVerbSelect = document.getElementById('base-verb-filter');
            const practiceTypeSelect = document.getElementById('practice-type-select');
            const practiceArea = document.getElementById('practice-area');
            const multipleChoiceOptionsContainer = document.getElementById('multiple-choice-options');
            const feedbackMessage = document.getElementById('feedback-message');
            const filterCardStatusSelect = document.getElementById('filter-card-status');
            const statusBtnNew = document.getElementById('btn-status-new');
            const statusBtnLearning = document.getElementById('btn-status-learning');
            const statusBtnLearned = document.getElementById('btn-status-learned');
            const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
            const filterSidebar = document.getElementById('filter-sidebar');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const tagsDisplayFront = document.getElementById('tags-display-front');
            const typingInputContainer = document.getElementById('typing-input-container');
            const typingInput = document.getElementById('typing-input');
            const submitTypingAnswerBtn = document.getElementById('submit-typing-answer-btn');
            const openAddCardModalBtn = document.getElementById('open-add-card-modal-btn');
            const addEditCardModal = document.getElementById('add-edit-card-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const addEditCardForm = document.getElementById('add-edit-card-form');
            const modalTitle = document.getElementById('modal-title');
            const cardIdInput = document.getElementById('card-id-input');
            const cardWordInput = document.getElementById('card-word-input');
            const cardPronunciationInput = document.getElementById('card-pronunciation-input');
            const cardMeaningInput = document.getElementById('card-meaning-input');
            const cardExampleInput = document.getElementById('card-example-input');
            const cardExampleVieInput = document.getElementById('card-example-vie-input');
            const cardNotesInput = document.getElementById('card-notes-input');
            const phrasalVerbSpecificFields = document.getElementById('phrasal-verb-specific-fields');
            const cardBaseVerbInput = document.getElementById('card-base-verb-input');
            const cardTagsInput = document.getElementById('card-tags-input');
            const cancelCardBtn = document.getElementById('cancel-card-btn');
            const saveCardBtn = document.getElementById('save-card-btn');
            const userCardActions = document.getElementById('user-card-actions');
            const editCardBtn = document.getElementById('edit-card-btn');
            const deleteCardBtn = document.getElementById('delete-card-btn');

            // State Variables
            let currentDatasetSource = 'web'; // 'web' or 'user'
            let currentData = [];
            let currentIndex = 0;
            let currentWordSpansMeta = [];
            let activeMasterList = []; 
            let practiceType = "off";
            let currentAnswerChecked = false;
            let currentCorrectAnswerForPractice = '';
            let cardStatuses = {};
            const cardStatusesStorageKey = 'flashcardCardStatuses_v2_crud_separated'; 
            let appState = {
                lastSelectedCategory: 'phrasalVerbs',
                lastSelectedSource: 'web',
                categoryStates: {} // { [source_category]: {filters, index} }
            };
            const appStateStorageKey = 'flashcardAppState_v2_crud_separated';
            const userCardsStorageKey = 'userFlashcards_v2_separated';
            let learningCardNextButtonTimer = null;
            let learningCardCountdownInterval = null;
            let exampleSpeechQueue = [];
            let currentExampleSpeechIndex = 0;
            let isSpeakingExampleQueue = false;
            let currentEditingCardId = null;

            // --- Initialization ---
            loadAppState();
            loadCardStatuses();
            setupInitialCategoryAndSource();
            setupEventListeners();

            // --- UI Functions ---
            function openSidebar() {
                filterSidebar.classList.remove('-translate-x-full');
                filterSidebar.classList.add('translate-x-0');
                sidebarOverlay.classList.remove('hidden');
                updateSidebarFilterVisibility();
            }

            function closeSidebar() {
                filterSidebar.classList.add('-translate-x-full');
                filterSidebar.classList.remove('translate-x-0');
                sidebarOverlay.classList.add('hidden');
            }

            function updateSidebarFilterVisibility() {
                const category = categorySelect.value;
                const isPhrasalVerb = category === 'phrasalVerbs';
                // Base verb and tag filters are primarily for web's structured data or user's phrasal verbs
                baseVerbFilterContainer.style.display = isPhrasalVerb ? 'block' : 'none';
                tagFilterContainer.style.display = isPhrasalVerb ? 'block' : 'none';
            }
            
            function updateMainHeaderTitle() {
                const sourceText = currentDatasetSource === 'web' ? "Thẻ của Web" : "Thẻ của Tôi";
                mainHeaderTitle.textContent = `Flashcard - ${sourceText}`;
            }


            function openAddEditModal(mode = 'add', cardData = null) {
                modalTitle.textContent = mode === 'add' ? 'Thêm thẻ mới (vào "Thẻ của Tôi")' : 'Sửa thẻ của Tôi';
                addEditCardForm.reset(); 
                cardIdInput.value = ''; 
                currentEditingCardId = null;
                // Phrasal verb fields are shown based on the *category selected for the new/edited card*
                // For simplicity, let's assume the modal uses the currently selected global category
                phrasalVerbSpecificFields.style.display = categorySelect.value === 'phrasalVerbs' ? 'block' : 'none';

                if (mode === 'edit' && cardData) {
                    currentEditingCardId = cardData.id; 
                    cardIdInput.value = cardData.id; 
                    if (categorySelect.value === 'phrasalVerbs') {
                        cardWordInput.value = cardData.phrasalVerb || '';
                        cardBaseVerbInput.value = cardData.baseVerb || '';
                        cardTagsInput.value = Array.isArray(cardData.tags) ? cardData.tags.filter(t => t !== 'all' && !t.startsWith('particle_')).join(', ') : '';
                    } else {
                        cardWordInput.value = cardData.word || '';
                    }
                    cardPronunciationInput.value = cardData.pronunciation || '';
                    cardMeaningInput.value = cardData.meaning || '';
                    cardExampleInput.value = (cardData.example || '').replace(/^Ví dụ:\s*/i, '').trim();
                    cardExampleVieInput.value = cardData.exampleVie || '';
                    cardNotesInput.value = cardData.notes || '';
                }
                addEditCardModal.classList.remove('hidden', 'opacity-0');
                addEditCardModal.querySelector('.modal-content').classList.remove('scale-95');
                addEditCardModal.querySelector('.modal-content').classList.add('scale-100');
            }

            function closeAddEditModal() {
                addEditCardModal.classList.add('opacity-0');
                addEditCardModal.querySelector('.modal-content').classList.add('scale-95');
                addEditCardModal.querySelector('.modal-content').classList.remove('scale-100');
                setTimeout(() => { addEditCardModal.classList.add('hidden'); }, 250);
            }
            
            function clearLearningTimer() {
                clearTimeout(learningCardNextButtonTimer); learningCardNextButtonTimer = null;
                clearInterval(learningCardCountdownInterval); learningCardCountdownInterval = null;
                if (nextBtn && nextBtn.textContent.includes('(')) {
                    nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                }
            }

            function startLearningTimer() {
                clearLearningTimer();
                if (currentData.length === 0 || practiceType !== "off" || !nextBtn) {
                    if (nextBtn) {
                        nextBtn.disabled = (currentIndex >= currentData.length - 1 || currentData.length === 0);
                         if (!nextBtn.textContent.includes('('))  nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                    }
                    updateCardInfo(); return;
                }
                const item = currentData[currentIndex];
                const categoryValue = categorySelect.value;
                const cardIdentifier = getCardIdentifier(item, categoryValue);
                const currentCardStatus = getCardStatus(cardIdentifier, categoryValue, item.isUserCard); // Pass isUserCard

                // Timer only for non-user cards in learning and if current source is web
                if (currentDatasetSource === 'web' && currentCardStatus === 'learning' && !item.isUserCard) {
                    nextBtn.disabled = true; let countdown = 30;
                    nextBtn.innerHTML = `Tiếp (${countdown}s) <i class="fas fa-arrow-right ml-1"></i>`;
                    learningCardCountdownInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            if (nextBtn.disabled) nextBtn.innerHTML = `Tiếp (${countdown}s) <i class="fas fa-arrow-right ml-1"></i>`;
                        } else { clearInterval(learningCardCountdownInterval); learningCardCountdownInterval = null; }
                    }, 1000);
                    learningCardNextButtonTimer = setTimeout(() => {
                        clearInterval(learningCardCountdownInterval); learningCardCountdownInterval = null;
                        nextBtn.disabled = false; nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                        updateCardInfo();
                    }, 30000);
                } else {
                    nextBtn.disabled = (currentIndex >= currentData.length - 1 || currentData.length === 0);
                    nextBtn.innerHTML = 'Tiếp <i class="fas fa-arrow-right ml-1"></i>';
                }
                updateCardInfo();
            }

            // --- State Management ---
            function loadAppState() {
                try {
                    const storedState = localStorage.getItem(appStateStorageKey);
                    if (storedState) {
                        const parsedState = JSON.parse(storedState);
                        appState.lastSelectedCategory = parsedState.lastSelectedCategory || 'phrasalVerbs';
                        appState.lastSelectedSource = parsedState.lastSelectedSource || 'web';
                        appState.categoryStates = parsedState.categoryStates || {};
                        Object.keys(appState.categoryStates).forEach(stateKey => { // stateKey is "source_category"
                            if (appState.categoryStates[stateKey]) {
                                appState.categoryStates[stateKey].searchTerm = ''; 
                            }
                        });
                    } else { // Default state
                         appState.lastSelectedCategory = 'phrasalVerbs';
                         appState.lastSelectedSource = 'web';
                         appState.categoryStates = {};
                    }
                } catch (e) {
                    console.warn("Không thể tải trạng thái ứng dụng:", e);
                    appState.lastSelectedCategory = 'phrasalVerbs';
                    appState.lastSelectedSource = 'web';
                    appState.categoryStates = {};
                }
            }

            function saveAppState() {
                try {
                    const currentCategoryValue = categorySelect.value;
                    const stateKey = `${currentDatasetSource}_${currentCategoryValue}`;
                    const stateForSourceCategory = getCategoryState(currentDatasetSource, currentCategoryValue); 
                    
                    stateForSourceCategory.currentIndex = currentIndex;
                    stateForSourceCategory.filterMarked = filterCardStatusSelect.value; 
                    if (currentCategoryValue === 'phrasalVerbs') { // These filters apply to both sources if phrasalVerbs
                        stateForSourceCategory.baseVerb = baseVerbSelect.value;
                        stateForSourceCategory.tag = tagSelect.value;
                    }
                    appState.lastSelectedCategory = currentCategoryValue; 
                    appState.lastSelectedSource = currentDatasetSource;
                    localStorage.setItem(appStateStorageKey, JSON.stringify(appState));
                } catch (e) {
                    console.warn("Không thể lưu trạng thái ứng dụng:", e);
                }
            }

            function getCategoryState(source, categoryValue) {
                const stateKey = `${source}_${categoryValue}`;
                if (!appState.categoryStates[stateKey]) {
                    appState.categoryStates[stateKey] = {
                        searchTerm: '', baseVerb: 'all', tag: 'all', filterMarked: 'all_study', currentIndex: 0
                    };
                } else {
                    if (appState.categoryStates[stateKey].searchTerm === undefined) {
                         appState.categoryStates[stateKey].searchTerm = '';
                    }
                }
                return appState.categoryStates[stateKey];
            }
            
            function loadCardStatuses() {
                try {
                    const storedStatuses = localStorage.getItem(cardStatusesStorageKey);
                    cardStatuses = storedStatuses ? JSON.parse(storedStatuses) : {};
                } catch (e) { console.error("Lỗi tải trạng thái thẻ:", e); cardStatuses = {}; }
            }

            function saveCardStatuses() {
                try { localStorage.setItem(cardStatusesStorageKey, JSON.stringify(cardStatuses)); } 
                catch (e) { console.error("Lỗi lưu trạng thái thẻ:", e); }
            }

            function getCardIdentifier(item, categoryValue) { // Remains the same
                if (!item) return null;
                return (categoryValue === 'phrasalVerbs') ? item.phrasalVerb : item.word;
            }
            
            // Modified to handle source for status storage if needed, though current key structure might be okay
            function getStatusKeyForStorage(cardIdentifier, categoryValue, isUserCard) {
                // For now, status key doesn't explicitly include source, relies on cardIdentifier being unique enough
                // or assumes statuses for user cards are handled alongside user card data if moved to Firestore.
                // If cardIdentifiers can clash between web and user, this needs refinement.
                // Let's assume for localStorage, the existing structure is fine.
                return cardIdentifier; 
            }


            function getCardStatus(cardIdentifier, categoryValue, isUserCard) {
                const statusKey = getStatusKeyForStorage(cardIdentifier, categoryValue, isUserCard);
                if (!statusKey || !categoryValue || !cardStatuses[categoryValue] || !cardStatuses[categoryValue][statusKey]) {
                    return 'new'; 
                }
                return cardStatuses[categoryValue][statusKey];
            }

            function setCardStatus(newStatus) {
                if (currentData.length === 0) return;
                const item = currentData[currentIndex];
                const categoryValue = categorySelect.value;
                const cardIdentifier = getCardIdentifier(item, categoryValue);
                if (!cardIdentifier) return;

                const statusKey = getStatusKeyForStorage(cardIdentifier, categoryValue, item.isUserCard);

                if (!cardStatuses[categoryValue]) cardStatuses[categoryValue] = {};
                cardStatuses[categoryValue][statusKey] = newStatus;
                saveCardStatuses();
                updateStatusButtonsUI(cardIdentifier, categoryValue); 
                startLearningTimer(); 
                if (newStatus === 'learned' && getCategoryState(currentDatasetSource, categoryValue).filterMarked === 'all_study') {
                     applyAllFilters(); 
                }
            }
            
            function updateStatusButtonsUI(cardIdentifier, categoryValue) {
                const statusButtons = [
                    { btn: statusBtnNew, status: 'new' }, { btn: statusBtnLearning, status: 'learning' }, { btn: statusBtnLearned, status: 'learned' }
                ];
                const item = currentData.length > 0 ? currentData[currentIndex] : null;

                if (!item || !cardIdentifier) {
                    statusButtons.forEach(obj => {
                        if(obj.btn) { 
                            obj.btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-700');
                            obj.btn.classList.add('bg-white', 'text-slate-700', 'border-slate-300');
                            obj.btn.disabled = true;
                        }
                    });
                    userCardActions.style.display = 'none'; 
                    return;
                }

                statusButtons.forEach(obj => { if(obj.btn) obj.btn.disabled = false; });
                const currentStatus = getCardStatus(cardIdentifier, categoryValue, item.isUserCard);
                statusButtons.forEach(obj => {
                    if (obj.btn) {
                        obj.btn.classList.toggle('bg-indigo-600', obj.status === currentStatus);
                        obj.btn.classList.toggle('text-white', obj.status === currentStatus);
                        // ... (rest of class toggling)
                    }
                });
                 if (statusBtnNew) statusBtnNew.disabled = (currentDatasetSource === 'web' && currentStatus === 'learning' && !item.isUserCard);

                userCardActions.style.display = item.isUserCard ? 'flex' : 'none';
            }

            // --- User Card Management (CRUD for localStorage) ---
            function loadUserCards() {
                try {
                    const storedUserCards = localStorage.getItem(userCardsStorageKey);
                    return storedUserCards ? JSON.parse(storedUserCards) : {}; // { category: [cards] }
                } catch (e) { console.error("Lỗi tải thẻ người dùng:", e); return {}; }
            }

            function saveUserCards(allUserCards) {
                try { localStorage.setItem(userCardsStorageKey, JSON.stringify(allUserCards)); } 
                catch (e) { console.error("Lỗi lưu thẻ người dùng:", e); }
            }

            function handleSaveCard() { // Saves to "Thẻ của Tôi"
                const category = categorySelect.value; // Use current global category for the new card
                const word = cardWordInput.value.trim();
                const meaning = cardMeaningInput.value.trim();
                if (!word || !meaning) { alert("Từ/Cụm từ và Nghĩa là bắt buộc!"); return; }

                const newCard = {
                    id: currentEditingCardId || `user_${category}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    pronunciation: cardPronunciationInput.value.trim(),
                    meaning: meaning, example: cardExampleInput.value.trim(),
                    exampleVie: cardExampleVieInput.value.trim(), notes: cardNotesInput.value.trim(),
                    isUserCard: true, category: category // Store category with the card
                };

                if (category === 'phrasalVerbs') {
                    newCard.phrasalVerb = word;
                    newCard.baseVerb = cardBaseVerbInput.value.trim() || null;
                    newCard.tags = cardTagsInput.value.trim() ? cardTagsInput.value.split(',').map(tag => tag.trim().toLowerCase()).filter(tag => tag) : [];
                } else { newCard.word = word; }

                const allUserCards = loadUserCards();
                if (!allUserCards[category]) allUserCards[category] = [];

                if (currentEditingCardId) { 
                    const cardIndex = allUserCards[category].findIndex(card => card.id === currentEditingCardId);
                    if (cardIndex > -1) {
                        const oldIdentifier = getCardIdentifier(allUserCards[category][cardIndex], category);
                        const newIdentifier = getCardIdentifier(newCard, category);
                        if (oldIdentifier !== newIdentifier && cardStatuses[category] && cardStatuses[category][oldIdentifier]) {
                            cardStatuses[category][newIdentifier] = cardStatuses[category][oldIdentifier];
                            delete cardStatuses[category][oldIdentifier];
                            saveCardStatuses();
                        }
                        allUserCards[category][cardIndex] = newCard;
                    } else allUserCards[category].push(newCard); 
                } else { 
                    const existingCardIndex = allUserCards[category].findIndex(card => getCardIdentifier(card, category).toLowerCase() === getCardIdentifier(newCard, category).toLowerCase());
                    if (existingCardIndex > -1) {
                        if (!confirm("Thẻ này đã tồn tại trong 'Thẻ của Tôi'. Cập nhật thẻ đó?")) return;
                        newCard.id = allUserCards[category][existingCardIndex].id;
                        allUserCards[category][existingCardIndex] = newCard;
                    } else allUserCards[category].push(newCard);
                }
                saveUserCards(allUserCards); closeAddEditModal();
                // If current view is user cards, reload to see changes. Otherwise, just notify.
                if (currentDatasetSource === 'user') {
                    loadVocabularyData(category); 
                }
                alert(currentEditingCardId ? "Đã cập nhật thẻ!" : "Đã thêm thẻ mới vào 'Thẻ của Tôi'!");
                currentEditingCardId = null;
            }
            
            function handleDeleteCard() {
                if (currentData.length === 0 || !currentData[currentIndex].isUserCard) return;
                const cardToDelete = currentData[currentIndex];
                if (!confirm(`Xóa thẻ "${getCardIdentifier(cardToDelete, categorySelect.value)}" khỏi "Thẻ của Tôi"?`)) return;
                
                const category = cardToDelete.category; // Use stored category on the card
                const allUserCards = loadUserCards();
                if (allUserCards[category]) {
                    const cardIdentifierToDelete = getCardIdentifier(cardToDelete, category);
                    allUserCards[category] = allUserCards[category].filter(card => card.id !== cardToDelete.id);
                    if (cardStatuses[category] && cardStatuses[category][cardIdentifierToDelete]) {
                        delete cardStatuses[category][cardIdentifierToDelete];
                        saveCardStatuses();
                    }
                    saveUserCards(allUserCards);
                }
                let newIndex = currentIndex;
                if (currentIndex === currentData.length - 1 && currentIndex > 0) newIndex = currentIndex -1;
                
                // Reload data for the current source and category
                loadVocabularyData(categorySelect.value).then(() => {
                    if (currentData.length > 0) {
                        currentIndex = Math.min(newIndex, currentData.length - 1);
                        if (currentIndex < 0) currentIndex = 0;
                    } else currentIndex = 0;
                    getCategoryState(currentDatasetSource, categorySelect.value).currentIndex = currentIndex;
                    saveAppState(); updateFlashcard();
                });
                alert("Đã xóa thẻ.");
            }

            // --- Utility Functions (Shuffle) ---
            function shuffleArray(array) { /* ... same as before ... */ return array; }
            
            // --- TTS Functions ---
            function speakText(textToSpeak, metaForHighlighting = [], onEndCallback = null) { /* ... same as before ... */ }
            function playNextExampleInQueue() { /* ... same as before ... */ }

            // --- Filter Population ---
            function populateBaseVerbFilter(dataArray) { /* ... same as before, operates on dataArray ... */ }
            function populateTagFilter(dataArray) { /* ... same as before, operates on dataArray ... */ }
            
            // --- Core Logic ---
            function applyAllFilters(calledFromLoadOrSourceChange = false) {
                clearLearningTimer(); 
                const currentCategoryValue = categorySelect.value;
                const stateForCurrentSourceCategory = getCategoryState(currentDatasetSource, currentCategoryValue); 
                let currentSearchTerm = searchInput.value.trim().toLowerCase(); 

                if (!calledFromLoadOrSourceChange) { // If user changes a filter directly
                    if (currentCategoryValue === 'phrasalVerbs') {
                        stateForCurrentSourceCategory.baseVerb = baseVerbSelect.value;
                        stateForCurrentSourceCategory.tag = tagSelect.value;
                    }
                    stateForCurrentSourceCategory.filterMarked = filterCardStatusSelect.value; 
                    stateForCurrentSourceCategory.currentIndex = 0; // Reset index on filter change
                }

                let listToProcess = [...activeMasterList]; 

                // Apply category-specific filters (baseVerb, tag) only if relevant
                if (currentCategoryValue === 'phrasalVerbs') {
                    if (stateForCurrentSourceCategory.baseVerb && stateForCurrentSourceCategory.baseVerb !== 'all') {
                        listToProcess = listToProcess.filter(item => item.baseVerb === stateForCurrentSourceCategory.baseVerb);
                    }
                     if (stateForCurrentSourceCategory.tag && stateForCurrentSourceCategory.tag !== 'all') {
                        listToProcess = listToProcess.filter(item => item.tags && item.tags.includes(stateForCurrentSourceCategory.tag));
                    }
                }
                
                if (currentSearchTerm) { 
                    listToProcess = listToProcess.filter(item => 
                        ((currentCategoryValue === 'phrasalVerbs' ? item.phrasalVerb : item.word) || '').toLowerCase().includes(currentSearchTerm)
                    );
                }
                
                const statusFilterValue = stateForCurrentSourceCategory.filterMarked; 
                if (statusFilterValue !== 'all_visible') { 
                     listToProcess = listToProcess.filter(item => {
                        const identifier = getCardIdentifier(item, currentCategoryValue);
                        const status = getCardStatus(identifier, currentCategoryValue, item.isUserCard);
                        if (statusFilterValue === 'all_study') return status === 'new' || status === 'learning';
                        // ... rest of status filtering
                        return true; 
                    });
                }
                
                currentData = listToProcess; 
                
                if (calledFromLoadOrSourceChange) {
                    currentIndex = stateForCurrentSourceCategory.currentIndex || 0; 
                     if (currentIndex >= currentData.length) { 
                         currentIndex = currentData.length > 0 ? Math.max(0, currentData.length - 1) : 0;
                    }
                } else {
                    currentIndex = 0;
                }
                stateForCurrentSourceCategory.currentIndex = currentData.length > 0 ? currentIndex : 0; 

                saveAppState(); 
                updateFlashcard(); 
            }

            async function loadVocabularyData(category) {
                clearLearningTimer();
                wordDisplay.innerHTML = '<span class="text-slate-500">Đang tải...</span>';
                // Reset common UI elements
                currentWordSpansMeta = []; pronunciationDisplay.textContent = ''; tagsDisplayFront.textContent = ''; 
                meaningDisplay.textContent = ''; exampleDisplay.innerHTML = ''; exampleVieDisplay.textContent = ''; notesDisplay.innerHTML = '';
                currentData = []; activeMasterList = []; 
                speakerBtn.disabled = true; speakerExampleBtn.disabled = true;
                
                const stateForCurrentSourceCategory = getCategoryState(currentDatasetSource, category);
                searchInput.value = ''; // Clear search on category or source change
                filterCardStatusSelect.value = stateForCurrentSourceCategory.filterMarked; 
                
                updateSidebarFilterVisibility(); // Update filters like base verb/tag based on category
                updateMainHeaderTitle(); // Update main title based on source

                // Reset filter dropdowns before populating
                baseVerbSelect.innerHTML = ''; tagSelect.innerHTML = ''; 
                if (category !== 'phrasalVerbs') { // If not phrasal verbs, ensure these filters are reset in state
                    stateForCurrentSourceCategory.baseVerb = 'all';
                    stateForCurrentSourceCategory.tag = 'all';
                }
                
                if (currentDatasetSource === 'web') {
                    try {
                        const response = await fetch(`data/${category}.json?v=${new Date().getTime()}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const jsonData = await response.json();
                        activeMasterList = (jsonData && jsonData[category]) ? jsonData[category].map(card => ({...card, isUserCard: false, category: category })) : [];
                    } catch (error) {
                        console.error("Lỗi tải dữ liệu Web:", error);
                        wordDisplay.innerHTML = '<span class="text-red-500">Lỗi tải dữ liệu Web!</span>';
                        activeMasterList = [];
                    }
                } else { // currentDatasetSource === 'user'
                    const allUserCards = loadUserCards();
                    activeMasterList = (allUserCards[category] || []).map(card => ({...card, isUserCard: true})); // Ensure isUserCard is set
                }
                activeMasterList = shuffleArray(activeMasterList);

                // Populate filters based on the loaded activeMasterList (applies to both web and user sources)
                if (category === 'phrasalVerbs' && activeMasterList.length > 0) {
                    populateBaseVerbFilter(activeMasterList); 
                    populateTagFilter(activeMasterList); 
                    baseVerbSelect.value = stateForCurrentSourceCategory.baseVerb || 'all';
                    tagSelect.value = stateForCurrentSourceCategory.tag || 'all';
                }
                
                applyAllFilters(true); // Pass true to indicate it's called from load or source change
                updateCardInfo(); // Final update for counts etc.
            }
            
            // --- Practice Mode Functions ---
            function displayMultipleChoiceOptions() { /* ... same as before ... */ }
            function checkMultipleChoiceAnswer(selectedAnswer, correctAnswer, selectedButton) { /* ... same as before ... */ }
            function checkTypingAnswer() { /* ... same as before ... */ }

            // --- Update Flashcard Display ---
            function updateFlashcard() { /* ... largely same as before, ensure isUserCard is checked for userCardActions ... */ 
                // ... (inside updateFlashcard)
                const item = currentData.length > 0 ? currentData[currentIndex] : null;
                if (item) {
                    // ... (rest of the logic to display card content)
                    const cardIdentifierForStatus = getCardIdentifier(item, categorySelect.value);
                    updateStatusButtonsUI(cardIdentifierForStatus, categorySelect.value); // This will handle userCardActions visibility
                } else {
                    // ... (logic for when no card data)
                    updateStatusButtonsUI(null, null);
                }
                // ...
            }

            function updateCardInfo() { /* ... same as before ... */ }
            
            // --- Event Handlers Setup ---
            function setupEventListeners() {
                // Sidebar
                hamburgerMenuBtn.addEventListener('click', openSidebar);
                closeSidebarBtn.addEventListener('click', closeSidebar);
                sidebarOverlay.addEventListener('click', closeSidebar);

                // Card Source Change
                cardSourceSelect.addEventListener('change', (e) => {
                    currentDatasetSource = e.target.value;
                    // Reset category to its "last selected" for this new source, or a default
                    const stateForNewSource = getCategoryState(currentDatasetSource, appState.categoryStates[`${currentDatasetSource}_${categorySelect.value}`]?.lastSelectedCategory || categorySelect.value);
                    // categorySelect.value = stateForNewSource.lastSelectedCategory || 'phrasalVerbs'; // This might be too complex, just reload current category for new source
                    practiceTypeSelect.value = "off"; practiceType = "off"; // Reset practice mode
                    loadVocabularyData(categorySelect.value); // Reload with current category for the new source
                });

                // Add/Edit/Delete Modal
                openAddCardModalBtn.addEventListener('click', () => openAddEditModal('add'));
                closeModalBtn.addEventListener('click', closeAddEditModal);
                cancelCardBtn.addEventListener('click', closeAddEditModal);
                addEditCardForm.addEventListener('submit', (e) => { e.preventDefault(); handleSaveCard(); });
                editCardBtn.addEventListener('click', () => {
                    if (currentData.length > 0 && currentData[currentIndex] && currentData[currentIndex].isUserCard) {
                        openAddEditModal('edit', currentData[currentIndex]);
                    }
                });
                deleteCardBtn.addEventListener('click', handleDeleteCard);

                // Filters and Category
                practiceTypeSelect.addEventListener('change', (e) => {
                    clearLearningTimer(); practiceType = e.target.value;
                    const category = categorySelect.value;
                    const state = getCategoryState(currentDatasetSource, category);
                    searchInput.value = ''; 
                    if (category === 'phrasalVerbs') { 
                        state.tag = 'all'; tagSelect.value = 'all'; 
                        state.baseVerb = 'all'; baseVerbSelect.value = 'all';
                    }
                    state.filterMarked = 'all_study'; filterCardStatusSelect.value = 'all_study';
                    state.currentIndex = 0; 
                    applyAllFilters(); closeSidebar(); 
                });
                categorySelect.addEventListener('change', (e) => {
                    clearLearningTimer(); const selectedCategory = e.target.value;
                    practiceTypeSelect.value = "off"; practiceType = "off";
                    // appState.lastSelectedCategory = selectedCategory; // Already saved in saveAppState
                    searchInput.value = ''; 
                    loadVocabularyData(selectedCategory); 
                    // updateSidebarFilterVisibility(); // Called within loadVocabularyData
                });
                baseVerbSelect.addEventListener('change', () => applyAllFilters(false)); // Pass false: direct filter change
                tagSelect.addEventListener('change', () => applyAllFilters(false));
                searchInput.addEventListener('input', () => applyAllFilters(false)); 
                filterCardStatusSelect.addEventListener('change', () => applyAllFilters(false));

                // Card Navigation & Interaction
                flipBtn.addEventListener('click', () => { /* ... */ });
                flashcard.addEventListener('click', (event) => { /* ... */ });
                nextBtn.addEventListener('click', () => { /* ... */ });
                prevBtn.addEventListener('click', () => { /* ... */ });
                speakerBtn.addEventListener('click', (event) => { /* ... */ });
                speakerExampleBtn.addEventListener('click', (event) => { /* ... */ });
                statusBtnNew.addEventListener('click', () => setCardStatus('new'));
                statusBtnLearning.addEventListener('click', () => setCardStatus('learning'));
                statusBtnLearned.addEventListener('click', () => setCardStatus('learned'));
                submitTypingAnswerBtn.addEventListener('click', checkTypingAnswer);
                typingInput.addEventListener('keypress', (e) => { /* ... */ });
            }

            function setupInitialCategoryAndSource() {
                cardSourceSelect.value = appState.lastSelectedSource || 'web';
                currentDatasetSource = cardSourceSelect.value;
                categorySelect.value = appState.lastSelectedCategory || 'phrasalVerbs'; 
                loadVocabularyData(categorySelect.value); 
            }
        });
    </script>
</body>
</html>
